<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç’°å³¶è·‘æ­¥ç´€éŒ„è¦–è¦ºåŒ–:index.html</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è¨­ç½® Firebase/Firestore çš„æ—¥èªŒç´šåˆ¥ï¼Œæ–¹ä¾¿èª¿è©¦
        setLogLevel('debug');

        // ==== LLM API é…ç½® (ä¿æŒä¸è®Š) ====
        const API_KEY = ""; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        
        // **** âš ï¸ ç®¡ç†è€…å¯†ç¢¼è¨­ç½® (è«‹è‡ªè¡Œä¿®æ”¹æ­¤å¯†ç¢¼) âš ï¸ ****
        const ADMIN_PIN = "123456"; 
        // **********************************************

        // ==== IMPORTANT: START Firebase Config (FOR GH Pages / Static Hosting) ====
        // ä½¿ç”¨è€…æä¾›çš„ dyps-run é…ç½®
        const GH_PAGES_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCuxRrZXNPrKWx9nrRiZyY_plxUkSISeFo",
            authDomain: "dyps-run.firebaseapp.com",
            projectId: "dyps-run",
            storageBucket: "dyps-run.firebasestorage.app",
            messagingSenderId: "691795460367",
            appId: "1:691795460367:web:fe6e2a323d1c4ff4bb3e7a",
            measurementId: "G-QHBBCYHYDP" 
        };
        // ==== IMPORTANT: END Firebase Config ====

        // ==== Global Variables (Adaptation for Static Hosting / Canvas) ====
        const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}';
        const firebaseConfig = isCanvasEnvironment 
            ? JSON.parse(__firebase_config) 
            : GH_PAGES_FIREBASE_CONFIG;
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const appId = isCanvasEnvironment 
            ? (typeof __app_id !== 'undefined' ? __app_id : 'default-running-app') 
            : 'beta4-gh-pages-running-app'; 

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Constants (ä¿æŒä¸è®Š)
        const LAPS_TO_METERS = 200; 
        const ISLAND_LAP_DISTANCE_M = 50000; 
        const AUTH_TIMEOUT_MS = 5000; 

        let currentUserId = null;
        let authReady = false;
        let studentTotalsData = {}; 
        let listenerActive = false; 
        
        // å°ç£æœ¬å³¶ç¸£å¸‚è³‡æ–™ (ä¿æŒä¸è®Š)
        const CITIES_DATA = [
            // ç¬¬ä¸€æ®µï¼šå—é‚Šæµ·å²¸ç·š (å³è‡³å·¦/æ±è‡³è¥¿) - è¦–è¦ºä¸Šæ‡‰å¾€å·¦ç§»å‹•
            { id: 'tainan', name: 'å°å—å¸‚', grid: 'col-start-5 row-start-5', color: 'bg-green-600', direction: 'left' }, 
            { id: 'kaohsiung', name: 'é«˜é›„å¸‚', grid: 'col-start-4 row-start-5', color: 'bg-zinc-600', direction: 'left' },
            { id: 'pingtung', name: 'å±æ±ç¸£', grid: 'col-start-3 row-start-5', color: 'bg-teal-600', direction: 'left' },
            { id: 'taitung', name: 'å°æ±ç¸£', grid: 'col-start-2 row-start-5', color: 'bg-cyan-600', direction: 'left' },
            { id: 'hualien', name: 'èŠ±è“®ç¸£', grid: 'col-start-1 row-start-5', color: 'bg-sky-400', direction: 'up' }, // è½‰è§’

            // ç¬¬äºŒæ®µï¼šæ±é‚Šæµ·å²¸ç·š (åº•è‡³ä¸Š/å—è‡³åŒ—) - è¦–è¦ºä¸Šæ‡‰å¾€ä¸Šç§»å‹•
            { id: 'yilan', name: 'å®œè˜­ç¸£', grid: 'col-start-1 row-start-4', color: 'bg-lime-500', direction: 'up' },
            { id: 'keelung', name: 'åŸºéš†å¸‚', grid: 'col-start-1 row-start-3', color: 'bg-emerald-500', direction: 'up' },
            { id: 'newtaipei', name: 'æ–°åŒ—å¸‚', grid: 'col-start-1 row-start-2', color: 'bg-pink-500', direction: 'up' },
            { id: 'taipei', name: 'å°åŒ—å¸‚', grid: 'col-start-1 row-start-1', color: 'bg-red-500', direction: 'right' }, // è½‰è§’

            // ç¬¬ä¸‰æ®µï¼šåŒ—é‚Šæµ·å²¸ç·š (å·¦è‡³å³/è¥¿è‡³æ±) - è¦–è¦ºä¸Šæ‡‰å¾€å³ç§»å‹•
            { id: 'taoyuan', name: 'æ¡ƒåœ’å¸‚', grid: 'col-start-2 row-start-1', color: 'bg-yellow-400', direction: 'right' },
            { id: 'hsinchucty', name: 'æ–°ç«¹ç¸£', grid: 'col-start-3 row-start-1', color: 'bg-teal-500', direction: 'right' },
            { id: 'miaoli', name: 'è‹—æ —ç¸£', grid: 'col-start-4 row-start-1', color: 'bg-purple-500', direction: 'right' },
            { id: 'taichung', name: 'å°ä¸­å¸‚', grid: 'col-start-5 row-start-1', color: 'bg-orange-500', direction: 'down' }, // è½‰è§’

            // ç¬¬å››æ®µï¼šè¥¿é‚Šæµ·å²¸ç·š (ä¸Šè‡³ä¸‹/åŒ—è‡³å—) - è¦–è¦ºä¸Šæ‡‰å¾€ä¸‹ç§»å‹•
            { id: 'changhua', name: 'å½°åŒ–ç¸£', grid: 'col-start-5 row-start-2', color: 'bg-rose-500', direction: 'down' },
            { id: 'yunlin', name: 'é›²æ—ç¸£', grid: 'col-start-5 row-start-3', color: 'bg-fuchsia-600', direction: 'down' }, 
            { id: 'chiayicty', name: 'å˜‰ç¾©ç¸£', grid: 'col-start-5 row-start-4', color: 'bg-pink-400', direction: 'down' }, // å˜‰ç¾©ç¸£ä½œç‚ºæŠ˜è¿”é»å‰ä¸€ç«™
        ];
        
        const TAIWAN_PATH_POINTS = [
            { id: 'tainan', name: 'å°å—å¸‚', progress: 0.0000 },
            { id: 'kaohsiung', name: 'é«˜é›„å¸‚', progress: 0.0625 },
            { id: 'pingtung', name: 'å±æ±ç¸£', progress: 0.1250 },
            { id: 'taitung', name: 'å°æ±ç¸£', progress: 0.1875 },
            { id: 'hualien', name: 'èŠ±è“®ç¸£', progress: 0.2500 },
            { id: 'yilan', name: 'å®œè˜­ç¸£', progress: 0.3125 },
            { id: 'keelung', name: 'åŸºéš†å¸‚', progress: 0.3750 },
            { id: 'newtaipei', name: 'æ–°åŒ—å¸‚', progress: 0.4375 },
            { id: 'taipei', name: 'å°åŒ—å¸‚', progress: 0.5000 },
            { id: 'taoyuan', name: 'æ¡ƒåœ’å¸‚', progress: 0.5625 },
            { id: 'hsinchucty', name: 'æ–°ç«¹ç¸£', progress: 0.6250 },
            { id: 'miaoli', name: 'è‹—æ —ç¸£', progress: 0.6875 },
            { id: 'taichung', name: 'å°ä¸­å¸‚', progress: 0.7500 },
            { id: 'changhua', name: 'å½°åŒ–ç¸£', progress: 0.8125 },
            { id: 'yunlin', name: 'é›²æ—ç¸£', progress: 0.8750 },
            { id: 'chiayicty', name: 'å˜‰ç¾©ç¸£', progress: 0.9375 },
            { id: 'tainan_end', name: 'å›åˆ°å°å—', progress: 1.0000 },
        ];
        
        // ==== Local Storage Functions (New for Persistence) ====
        
        /**
         * å„²å­˜ä½¿ç”¨è€…çš„å§“åå’Œåº§è™Ÿåˆ°ç€è¦½å™¨æœ¬åœ°å„²å­˜ã€‚
         */
        function saveIdentity(name, studentId) {
            try {
                localStorage.setItem('studentName', name);
                localStorage.setItem('studentId', studentId);
            } catch (e) {
                console.warn("ç„¡æ³•ä½¿ç”¨ localStorage å„²å­˜èº«ä»½ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚", e);
            }
        }

        /**
         * å¾ç€è¦½å™¨æœ¬åœ°å„²å­˜è¼‰å…¥ä½¿ç”¨è€…çš„å§“åå’Œåº§è™Ÿã€‚
         */
        function loadIdentity() {
            try {
                const name = localStorage.getItem('studentName');
                const studentId = localStorage.getItem('studentId');
                
                if (name) document.getElementById('name').value = name;
                if (studentId) document.getElementById('studentId').value = studentId;
            } catch (e) {
                console.warn("ç„¡æ³•å¾ localStorage è¼‰å…¥èº«ä»½ã€‚", e);
            }
        }

        // ==== Firestore & Auth Functions ====
        
        const getCollectionRef = () => {
            // æ•¸æ“šå„²å­˜åœ¨å…¬å…±é›†åˆï¼Œç¢ºä¿æ‰€æœ‰äººéƒ½å¯è®€å¯«å’Œæ•´åˆ
            return collection(db, `artifacts/${appId}/public/data/running_records`);
        };

        function updateAuthStatusUI() {
            const statusElement = document.getElementById('authStatus');
            if (authReady && currentUserId) {
                statusElement.textContent = `âœ… é€£ç·šæˆåŠŸ (ä½¿ç”¨è€… ID: ${currentUserId.substring(0, 8)}...)`;
                statusElement.className = 'text-sm font-semibold text-green-700 p-2 rounded-lg bg-green-100 mb-4';
                
                if (!isCanvasEnvironment) {
                     statusElement.title = `App ID: ${appId}\nUser ID: ${currentUserId}`;
                }

            } else if (authReady && !currentUserId) {
                 statusElement.textContent = 'âŒ é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•å–å¾— IDã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase é©—è­‰è¨­å®šã€‚';
                statusElement.className = 'text-sm font-semibold text-red-700 p-2 rounded-lg bg-red-100 mb-4';
            } else {
                statusElement.textContent = 'âŒ› æ­£åœ¨é€£ç·šåˆ°è³‡æ–™åº«...';
                statusElement.className = 'text-sm font-semibold text-yellow-700 p-2 rounded-lg bg-yellow-100 mb-4';
            }
        }

        /**
         * é©—è­‰åˆå§‹åŒ–å‡½å¼ï¼ŒåŠ å…¥äº†æ›´è©³ç´°çš„éŒ¯èª¤è™•ç†ã€‚
         */
        async function initAuthAndListener() {
            try {
                // 1. å˜—è©¦ä½¿ç”¨è‡ªè¨‚ Token ç™»å…¥ (Canvas ç’°å¢ƒ)
                if (isCanvasEnvironment && initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } 
                
                // 2. å¦‚æœå°šæœªç™»å…¥ï¼Œå‰‡å›é€€åˆ°åŒ¿åç™»å…¥ (GitHub Pages æˆ–ä¸€èˆ¬éƒ¨ç½²ç’°å¢ƒ)
                if (!auth.currentUser) {
                    await signInAnonymously(auth); 
                } 
                
                currentUserId = auth.currentUser ? auth.currentUser.uid : null;

                if (currentUserId) {
                    authReady = true;
                    updateAuthStatusUI();
                    // åªæœ‰åœ¨é©—è­‰æˆåŠŸå¾Œæ‰è¨­å®šç›£è½å™¨ï¼Œç¢ºä¿æ•¸æ“šå¯ä»¥è¼‰å…¥
                    if (!listenerActive) {
                        setupRealtimeListener();
                        listenerActive = true;
                    }
                } else {
                    throw new Error("Authentication failed: Could not retrieve User ID after sign-in attempt.");
                }

            } catch (error) {
                console.error("Critical Firebase Auth Error:", error);
                
                let userMessage = "âŒ Firebase é€£ç·šéŒ¯èª¤ï¼";
                if (error.code === 'auth/operation-not-allowed') {
                    userMessage += "è«‹ç«‹å³æª¢æŸ¥æ‚¨çš„ **Firebase > Authentication > ç™»å…¥æ–¹å¼**ï¼Œ**å•Ÿç”¨åŒ¿åé©—è­‰ (Anonymous)**ï¼";
                } else {
                     userMessage += `è«‹æª¢æŸ¥æ‚¨çš„å¾Œå°è¨­å®šã€‚ (éŒ¯èª¤ç¢¼: ${error.code || 'UNKNOWN'})`;
                }

                showMessageBox(userMessage, "error");
                
                authReady = true; 
                currentUserId = null;
                updateAuthStatusUI(); 
            }
        }
        
        async function waitForAuth() {
            return new Promise((resolve) => {
                if (authReady && currentUserId) {
                    return resolve(true);
                }
                
                const startTime = Date.now();
                const checkInterval = setInterval(() => {
                    if (authReady && currentUserId) {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (Date.now() - startTime > AUTH_TIMEOUT_MS) {
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }
        
        // ==== æ•¸æ“šåˆªé™¤æ ¸å¿ƒåŠŸèƒ½ (ä¿æŒä¸è®Š) ====
        async function deleteAllRecords() {
            const recordsRef = getCollectionRef();
            const q = query(recordsRef);
            
            try {
                const snapshot = await getDocs(q); 
                const batchSize = snapshot.docs.length;

                if (batchSize === 0) {
                    showMessageBox("ç›®å‰æ²’æœ‰æ•¸æ“šéœ€è¦æ¸…é™¤ã€‚", "info");
                    return;
                }
                
                const deleteButton = document.getElementById('confirmDeleteButton');
                const originalText = deleteButton.textContent;
                
                deleteButton.disabled = true;
                deleteButton.textContent = `ğŸ§¹ æ­£åœ¨æ¸…é™¤ ${batchSize} ç­†æ•¸æ“š...`;

                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));

                await Promise.all(deletePromises);
                
                showMessageBox(`âœ… æˆåŠŸæ¸…é™¤æ‰€æœ‰ ${batchSize} ç­†è·‘æ­¥ç´€éŒ„ã€‚`, "success");
                
            } catch (error) {
                console.error("Error deleting all documents: ", error);
                showMessageBox(`âŒ æ¸…é™¤æ•¸æ“šå¤±æ•— (éŒ¯èª¤: ${error.code || error.message})`, "error");
            } finally {
                const deleteButton = document.getElementById('confirmDeleteButton');
                deleteButton.disabled = false;
                deleteButton.textContent = 'ç¢ºèªåˆªé™¤';
                closeConfirmationModal();
            }
        }

        function resetDataHandler() {
            showConfirmationModal(
                "âš ï¸ ç®¡ç†è€…æ•¸æ“šæ¸…é™¤", 
                "æ­¤æ“ä½œå°‡**æ°¸ä¹…åˆªé™¤**æ‡‰ç”¨ç¨‹å¼ä¸­æ‰€æœ‰å­¸ç”Ÿçš„è·‘æ­¥ç´€éŒ„ï¼æ¸…é™¤å¾Œç„¡æ³•å¾©åŸã€‚è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ç¹¼çºŒã€‚", 
                () => {
                    const pinInput = document.getElementById('adminPinInput');
                    const enteredPin = pinInput.value.trim();
                    pinInput.value = ''; 
                    
                    if (enteredPin === ADMIN_PIN) {
                        deleteAllRecords();
                    } else {
                        showMessageBox("âŒ å¯†ç¢¼éŒ¯èª¤ï¼ç„¡æ³•åŸ·è¡Œæ•¸æ“šæ¸…é™¤ã€‚", "error");
                        closeConfirmationModal(); 
                    }
                }
            );
        }

        // ==== DOMContentLoaded / Init (åŒ…å«æ–°çš„ Identity è¼‰å…¥) ====
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('recordForm');
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            form.addEventListener('submit', handleFormSubmit);
            
            // NEW: è¼‰å…¥å…ˆå‰å„²å­˜çš„å§“åå’Œåº§è™Ÿ
            loadIdentity(); 
            
            const resetButton = document.getElementById('resetDataButton');
            resetButton.addEventListener('click', resetDataHandler);

            const generateButton = document.getElementById('generateReflectionButton');
            generateButton.addEventListener('click', (e) => {
                e.preventDefault();
                const name = document.getElementById('name').value.trim();
                const studentId = document.getElementById('studentId').value.trim();
                
                if (!name || !studentId) {
                    showMessageBox("è«‹å…ˆè¼¸å…¥å§“åå’Œåº§è™Ÿï¼Œæ‰èƒ½å–å¾—å€‹äººåŒ– AI å¿ƒå¾—ã€‚", "info");
                    return;
                }
                
                generateReflection(name, studentId);
            });
            
            document.getElementById('confirmDeleteButton').addEventListener('click', () => {
                const callback = window.currentConfirmationCallback;
                if (callback && typeof callback === 'function') {
                    callback();
                } else {
                    closeConfirmationModal(); 
                }
            });

            document.getElementById('cancelDeleteButton').addEventListener('click', closeConfirmationModal);


            buildBlockMap();

            updateAuthStatusUI();
            initAuthAndListener();
        });

        // ä»¥ä¸‹å‡½å¼ä¿æŒä¸è®Šï¼š
        
        /**
         * å‹•æ…‹ç”Ÿæˆç¸£å¸‚è‰²å¡Šåœ°åœ– (ä¿æŒä¸è®Š)
         */
        function buildBlockMap() {
            const mapGrid = document.getElementById('taiwan-map-grid');
            mapGrid.innerHTML = `
                <!-- ä¸­å¤®ç«¶è³½ä¸»é¡Œæ’åœ– (3x3 å€å¡Š) -->
                <div id="central-illustration" class="grid-center-area flex flex-col items-center justify-center p-4">
                    <!-- Trophy SVG (ä»£è¡¨ç«¶è³½èˆ‡ç›®æ¨™) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 fill-yellow-200">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                        <path d="M4 22h16"></path>
                        <path d="M10 14h4"></path>
                        <path d="M12 17v5"></path>
                        <path d="M12 12A6 6 0 0 0 5 8c0-1.5 1-4 2-5h10c1 1 2 3.5 2 5a6 6 0 0 0-7 4"></path>
                    </svg>
                    <p class="text-2xl font-black text-indigo-700 mt-2 text-center leading-tight">ç’°å³¶æŒ‘æˆ°è³½<br/>GO GO GO!</p>
                </div>
            `; 
            
            CITIES_DATA.forEach(region => {
                const block = document.createElement('div');
                block.id = `block-${region.id}`;
                block.className = `city-block ${region.grid} ${region.color} relative`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = region.name;
                nameSpan.className = 'text-center z-10';

                const markerContainer = document.createElement('div');
                markerContainer.id = `marker-container-${region.id}`;
                markerContainer.className = 'absolute inset-0 pointer-events-none z-20';

                block.appendChild(nameSpan);
                block.appendChild(markerContainer);
                mapGrid.appendChild(block);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const authSuccess = await waitForAuth();
            if (!authSuccess || !currentUserId) {
                showMessageBox("ç„¡æ³•å–å¾—ä½¿ç”¨è€…èº«ä»½ï¼Œè«‹åˆ·æ–°é é¢æˆ–ç¢ºèªé€£ç·šç‹€æ…‹ã€‚", "error");
                return;
            }
            
            const name = document.getElementById('name').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const date = document.getElementById('date').value;
            const laps = parseInt(document.getElementById('laps').value, 10);

            if (!name || !studentId || !date || isNaN(laps) || laps <= 0) {
                showMessageBox("è«‹ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ï¼Œä¸”åœˆæ•¸å¤§æ–¼ 0ã€‚", "info");
                return;
            }
            
            // NEW: æäº¤å‰ä¿å­˜èº«ä»½
            saveIdentity(name, studentId); 
            
            const distanceMeters = laps * LAPS_TO_METERS;

            const record = {
                name: name,
                studentId: studentId,
                date: date,
                laps: laps,
                distanceMeters: distanceMeters,
                submittedBy: currentUserId,
                timestamp: serverTimestamp()
            };

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'å„²å­˜ä¸­...';

            try {
                await addDoc(getCollectionRef(), record);
                showMessageBox("è·‘æ­¥ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼", "success");
                document.getElementById('laps').value = '';
                
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox(`å„²å­˜ç´€éŒ„å¤±æ•— (éŒ¯èª¤: ${error.code || error.message})`, "error");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'æäº¤ç´€éŒ„';
            }
        }
        
        function getCityInfoByProgress(progress) {
            const currentProgress = progress % 1.0; 
            
            for (let i = 0; i < TAIWAN_PATH_POINTS.length - 1; i++) {
                const p1 = TAIWAN_PATH_POINTS[i];
                const p2 = TAIWAN_PATH_POINTS[i + 1];

                if (currentProgress >= p1.progress && currentProgress < p2.progress) {
                    const segmentLength = p2.progress - p1.progress;
                    const progressInCity = (currentProgress - p1.progress) / segmentLength; // 0.0 ~ 1.0
                    
                    return {
                        cityId: p1.id,
                        cityName: p1.name.replace(/\/.*/, '').replace('å›åˆ°', ''),
                        progressInCity: progressInCity
                    };
                }
            }
            
            if (currentProgress === 0.0 && progress > 0) {
                 const startCity = TAIWAN_PATH_POINTS[0];
                 return {
                    cityId: startCity.id,
                    cityName: startCity.name.replace(/\/.*/, '').replace('å›åˆ°', ''),
                    progressInCity: 1.0 
                };
            }
            
            const startCity = TAIWAN_PATH_POINTS[0];
            return {
                cityId: startCity.id,
                cityName: startCity.name.replace(/\/.*/, '').replace('å›åˆ°', ''),
                progressInCity: 0.0
            };
        }

        async function generateReflection(studentName, studentId) {
            const reflectionBox = document.getElementById('aiReflectionContent');
            const generateButton = document.getElementById('generateReflectionButton');

            const student = studentTotalsData[studentId];
            if (!student) {
                reflectionBox.innerHTML = '<p class="text-red-500">âŒ æ‰¾ä¸åˆ°è©²åº§è™Ÿçš„è·‘æ­¥ç´€éŒ„ã€‚è«‹å…ˆæäº¤è‡³å°‘ä¸€æ¬¡ç´€éŒ„ã€‚</p>';
                return;
            }

            generateButton.disabled = true;
            generateButton.innerHTML = 'âœ¨ æ­£åœ¨ç”¢ç”Ÿå¿ƒå¾—...';
            reflectionBox.innerHTML = '<p class="text-gray-500 animate-pulse">æ­£åœ¨èˆ‡ AI æ•™ç·´é€£ç·šï¼Œè«‹ç¨å€™...</p>';
            
            const totalDistance = student.totalDistanceM;
            const totalKm = (totalDistance / 1000).toFixed(2);
            const fullLaps = Math.floor(totalDistance / ISLAND_LAP_DISTANCE_M);
            const currentLapProgress = (totalDistance % ISLAND_LAP_DISTANCE_M) / ISLAND_LAP_DISTANCE_M;
            
            const cityInfo = getCityInfoByProgress(currentLapProgress);
            const location = cityInfo.cityName;
            const progressInCityPercent = (cityInfo.progressInCity * 100).toFixed(0);

            const nextLapKm = ((fullLaps + 1) * ISLAND_LAP_DISTANCE_M / 1000).toFixed(2);

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å……æ»¿æ´»åŠ›ä¸”å¯Œæœ‰æ´å¯ŸåŠ›çš„å­¸ç”Ÿé«”è‚²æ•™ç·´ã€‚æ ¹æ“šå­¸ç”Ÿåœ¨è™›æ“¬ç’°å³¶è·‘é“ä¸Šçš„ç¸½é‡Œç¨‹å’Œé€²åº¦ï¼Œä»¥ç¹é«”ä¸­æ–‡æ’°å¯«ä¸€ä»½ç°¡çŸ­ã€å…·æ¿€å‹µæ€§ä¸”å€‹æ€§åŒ–çš„è·‘æ­¥åˆ†ææˆ–å¿ƒå¾—ã€‚é‡é»é¼“å‹µä»–å€‘çš„åŠªåŠ›ä¸¦æåŠä»–å€‘æ‰€åœ¨çš„å¤§æ¦‚åœ°ç†ä½ç½®ã€‚é™åˆ¶åœ¨ä¸‰åˆ°å››å¥è©±å…§ã€‚";

            const userQuery = `è«‹ç‚ºå­¸ç”Ÿ ${studentName} (åº§è™Ÿ ${studentId}) æ’°å¯«å¿ƒå¾—ã€‚ä»–å€‘ç›®å‰ç¸½é‡Œç¨‹ç‚º ${totalKm} å…¬é‡Œã€‚å·²å®Œæˆ ${fullLaps} æ¬¡ç’°å³¶ã€‚åœ¨ç•¶å‰ç’°å³¶é€²åº¦ä¸­ï¼Œä»–å€‘æ­£ä½æ–¼ ${location}ï¼Œé€²åº¦ç´„ ${progressInCityPercent}%ã€‚ä¸‹ä¸€å€‹å®Œæ•´ç’°å³¶é‡Œç¨‹ç¢‘æ˜¯ ${nextLapKm} å…¬é‡Œã€‚è«‹å°ˆæ³¨æ–¼é¼“å‹µå’Œåˆ†æã€‚`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let resultText = '';

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    resultText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (resultText) {
                        break; 
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        resultText = `å¾ˆæŠ±æ­‰ï¼ŒAI æ•™ç·´é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ (${error.message})`;
                    }
                }
            }

            if (resultText) {
                 reflectionBox.innerHTML = `<p class="text-gray-700 leading-relaxed italic border-l-4 border-indigo-400 pl-4">${resultText}</p>`;
            } else {
                 reflectionBox.innerHTML = '<p class="text-red-500">AI æ•™ç·´æœªèƒ½ç”¢ç”Ÿå¿ƒå¾—ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p>';
            }

            generateButton.disabled = false;
            generateButton.innerHTML = 'âœ¨ å–å¾— AI è·‘æ­¥å¿ƒå¾—';
        }
        
        function setupRealtimeListener() {
            // æŸ¥è©¢æ‰€æœ‰ç´€éŒ„ï¼Œä¸¦ä¾ç…§æ™‚é–“æˆ³è¨˜å€’åºæ’åˆ— (ç¢ºä¿æœ€æ–°ç´€éŒ„å…ˆé¡¯ç¤º)
            const recordsQuery = query(getCollectionRef(), orderBy("timestamp", "desc"));

            // onSnapshot è¨‚é–±å³æ™‚æ•¸æ“šè®ŠåŒ–
            onSnapshot(recordsQuery, (snapshot) => {
                const allRecords = [];
                snapshot.forEach((doc) => {
                    allRecords.push(doc.data());
                });
                // è™•ç†æ‰€æœ‰ç´€éŒ„ï¼Œè¨ˆç®—ç¸½é‡Œç¨‹ä¸¦æ›´æ–° UI
                processRecords(allRecords);
            }, (error) => {
                console.error("Error listening to running records:", error);
                showMessageBox("ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«æˆ–æ¬Šé™ä¸è¶³ã€‚ç„¡æ³•é¡¯ç¤ºæ’è¡Œæ¦œã€‚", "error");
            });
        }

        function processRecords(records) {
            const studentTotals = {};
            const leaderboard = document.getElementById('leaderboard');
            
            leaderboard.innerHTML = ''; 
            
            // æ ¸å¿ƒé‚è¼¯ï¼šæ ¹æ“š studentId ç´¯è¨ˆç¸½é‡Œç¨‹
            records.forEach(record => {
                const key = record.studentId;
                if (!studentTotals[key]) {
                    studentTotals[key] = {
                        name: record.name,
                        studentId: key,
                        totalDistanceM: 0,
                        laps: 0
                    };
                }
                const distance = typeof record.distanceMeters === 'number' ? record.distanceMeters : 0;
                studentTotals[key].totalDistanceM += distance;
            });
            
            studentTotalsData = studentTotals;
            
            let students = Object.values(studentTotals);
            // æ’åºï¼šç¸½é‡Œç¨‹ç”±é«˜åˆ°ä½
            students.sort((a, b) => b.totalDistanceM - a.totalDistanceM);

            // æ›´æ–°æ’è¡Œæ¦œ UI
            students.forEach((student, index) => {
                const totalKm = (student.totalDistanceM / 1000).toFixed(2);
                const li = document.createElement('li');
                li.className = 'p-3 bg-white/70 backdrop-blur-sm rounded-xl flex justify-between items-center shadow-md mb-2 transition-all duration-300 hover:shadow-lg';
                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg w-6 text-center text-indigo-600">${index + 1}</span>
                        <span class="text-gray-800 font-medium truncate">${student.name} (${student.studentId})</span>
                    </div>
                    <span class="font-mono text-xl text-green-700">${totalKm} KM</span>
                `;
                leaderboard.appendChild(li);
            });
            
            // æ›´æ–°åœ°åœ–è¦–è¦ºåŒ–
            updateMap(students);
        }

        function updateMap(students) {
            CITIES_DATA.forEach(city => {
                const container = document.getElementById(`marker-container-${city.id}`);
                if (container) {
                    container.innerHTML = '';
                }
                const cityBlock = document.getElementById(`block-${city.id}`);
                const existingBars = cityBlock ? cityBlock.querySelectorAll('.progress-bar-student') : [];
                existingBars.forEach(bar => bar.remove());
            });

            students.forEach(student => {
                const totalDistance = student.totalDistanceM;
                const fullLaps = Math.floor(totalDistance / ISLAND_LAP_DISTANCE_M);
                const currentLapProgress = (totalDistance % ISLAND_LAP_DISTANCE_M) / ISLAND_LAP_DISTANCE_M;
                
                const { cityId, progressInCity } = getCityInfoByProgress(currentLapProgress);
                const cityData = CITIES_DATA.find(c => c.id === cityId);
                
                if (!cityData) return;
                const direction = cityData.direction;

                const cityBlock = document.getElementById(`block-${cityId}`);
                const container = document.getElementById(`marker-container-${cityId}`);
                
                if (!cityBlock || !container) return; 

                // 1. ç¸£å¸‚å…§çš„é€²åº¦æ¢ (Progress Bar)
                let progressBar = document.getElementById(`progress-bar-${student.studentId}`);
                
                if (progressBar && progressBar.parentElement !== cityBlock) {
                    progressBar.parentElement.removeChild(progressBar);
                    progressBar = null; 
                }
                
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.id = `progress-bar-${student.studentId}`;
                    progressBar.className = 'absolute transition-all duration-1000 ease-out z-0 opacity-80 progress-bar-student';
                    cityBlock.appendChild(progressBar);
                }
                
                progressBar.style.top = '';
                progressBar.style.bottom = '';
                progressBar.style.left = '';
                progressBar.style.right = '';
                progressBar.style.width = '';
                progressBar.style.height = ''; 

                const progressPercent = `${progressInCity * 100}%`;
                progressBar.style.backgroundColor = getColorHash(student.studentId);
                
                const barThickness = '4px';

                switch (direction) {
                    case 'right': 
                        progressBar.style.bottom = '0';
                        progressBar.style.left = '0';
                        progressBar.style.height = barThickness;
                        progressBar.style.width = progressPercent;
                        break;
                    case 'left': 
                        progressBar.style.bottom = '0';
                        progressBar.style.right = '0'; 
                        progressBar.style.height = barThickness;
                        progressBar.style.width = progressPercent;
                        break;
                    case 'up': 
                        progressBar.style.bottom = '0';
                        progressBar.style.left = '0'; 
                        progressBar.style.width = barThickness;
                        progressBar.style.height = progressPercent;
                        break;
                    case 'down': 
                        progressBar.style.top = '0';
                        progressBar.style.right = '0'; 
                        progressBar.style.width = barThickness;
                        progressBar.style.height = progressPercent;
                        break;
                }
                
                // 2. æ¨™è¨˜ (Marker)
                const markerSizeHalf = 12; 
                const markerPosition = `calc(${progressInCity * 100}% - ${markerSizeHalf}px)`; 
                
                let marker = document.getElementById(`marker-${student.studentId}`);
                if (!marker) {
                    marker = document.createElement('div');
                    marker.id = `marker-${student.studentId}`;
                    marker.className = `student-marker absolute w-6 h-6 rounded-full shadow-lg border-2 border-white flex items-center justify-center font-bold text-xs transition-all duration-1000 ease-out z-30`;
                    container.appendChild(marker); 
                }
                
                marker.style.top = '';
                marker.style.left = '';
                marker.style.right = '';
                marker.style.bottom = '';
                marker.style.transform = ''; 

                const color = getColorHash(student.studentId);
                marker.style.backgroundColor = color;
                marker.style.color = getTextColor(color);
                marker.title = `${student.name} (${student.studentId})ï¼šç¸½é‡Œç¨‹ ${(totalDistance / 1000).toFixed(2)} KM (å·²å®Œæˆ ${fullLaps} æ¬¡ç’°å³¶)`;
                
                marker.textContent = student.studentId; 
                
                const markerOffset = '-2px';
                
                switch (direction) {
                    case 'right': 
                        marker.style.bottom = markerOffset;
                        marker.style.left = markerPosition;
                        marker.style.transform = 'translateX(-50%)'; 
                        break;
                    case 'left': 
                        marker.style.bottom = markerOffset;
                        marker.style.right = markerPosition;
                        marker.style.transform = 'translateX(50%)'; 
                        break;
                    case 'up': 
                        marker.style.left = markerOffset;
                        marker.style.bottom = markerPosition;
                        marker.style.transform = 'translateY(50%)'; 
                        break;
                    case 'down': 
                        marker.style.right = markerOffset;
                        marker.style.top = markerPosition;
                        marker.style.transform = 'translateY(-50%)'; 
                        break;
                }
                
                if (marker.parentElement !== container) {
                    container.appendChild(marker);
                }
            });
        }
        
        function getColorHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        function getTextColor(hexcolor) {
            const r = parseInt(hexcolor.substring(1, 3), 16);
            const g = parseInt(hexcolor.substring(3, 5), 16);
            const b = parseInt(hexcolor.substring(5, 7), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return (brightness > 150) ? 'black' : 'white';
        }

        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('messageBox');
            const content = document.getElementById('messageContent');
            const icon = document.getElementById('messageIcon');
            const boxClasses = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700'
            };
            const iconContent = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            box.className = `fixed bottom-5 right-5 p-4 border rounded-lg shadow-xl z-50 transition-transform duration-300 transform translate-x-0 ${boxClasses[type]}`;
            icon.textContent = iconContent[type];
            content.textContent = message;

            setTimeout(() => {
                box.classList.add('translate-x-full');
            }, 8000); // å»¶é•·é¡¯ç¤ºæ™‚é–“ï¼Œè®“ä½¿ç”¨è€…æœ‰æ™‚é–“é–±è®€éŒ¯èª¤ç¢¼
            
            box.classList.remove('translate-x-full');
        }
        
        function showConfirmationModal(title, message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').innerHTML = message;
            
            window.currentConfirmationCallback = callback; 
            
            modal.classList.remove('hidden');
            const pinInput = document.getElementById('adminPinInput');
            pinInput.value = '';
            setTimeout(() => pinInput.focus(), 100);
        }

        function closeConfirmationModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            window.currentConfirmationCallback = null;
        }

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* è‰²å¡Šåœ°åœ–ç¶²æ ¼å®¹å™¨ */
        #taiwan-map-grid {
            /* èª¿æ•´ç‚º 5x5 çŸ©å½¢ä½ˆå±€ */
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr)); 
            grid-template-rows: repeat(5, minmax(80px, 1fr)); /* ç¢ºä¿æ¯è¡Œæœ‰æœ€å°é«˜åº¦ */
            gap: 4px; /* å¢åŠ é–“éš™ */
            background-color: #ecf0f1; 
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            height: auto;
            overflow: hidden; /* éš±è—åœ“è§’å¤–çš„éƒ¨åˆ† */
        }
        
        /* å®šç¾©æ¯å€‹ç¸£å¸‚æ–¹å¡Šçš„å…±åŒæ¨£å¼ */
        .city-block {
            @apply p-2 text-white font-bold text-base flex items-center justify-center shadow-inner transition-all duration-300 ease-in-out cursor-default;
            border: 2px solid rgba(255, 255, 255, 0.6); /* ç™½è‰²é‚Šæ¡†å¼·èª¿åˆ†é›¢ */
            min-height: 80px; 
            overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æœƒæº¢å‡º */
        }

        /* è®“æ–‡å­—åœ¨æ–¹å¡Šä¸­å±…ä¸­ï¼Œä¸¦ç¢ºä¿æ¨™è¨˜å¯ä»¥æ­£ç¢ºå®šä½ */
        .city-block > span {
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
        }

        .student-marker {
            /* æ¨™è¨˜å¤§å°èª¿æ•´ */
            width: 24px;
            height: 24px;
            border: 3px solid white; /* å¼·èª¿æ¨™è¨˜ */
        }
        
        /* ä¸­å¤®ç«¶è³½ä¸»é¡Œå€å¡Š CSS */
        .grid-center-area {
            grid-column: 2 / 5; /* æ©«è·¨ç¬¬ 2 åˆ°ç¬¬ 4 åˆ— */
            grid-row: 2 / 5;    /* æ©«è·¨ç¬¬ 2 åˆ°ç¬¬ 4 è¡Œ */
            background-color: #ffffff; /* ç™½è‰²èƒŒæ™¯èˆ‡å‘¨åœåœ°åœ–å€å¡Šå½¢æˆå°æ¯” */
            border: 4px dashed #6366f1; /* è™›ç·šé‚Šæ¡†å¼·èª¿ä¸­å¤®ç«¶è³½å€ */
            border-radius: 1rem;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            z-index: 5; /* ç¢ºä¿å®ƒåœ¨é€²åº¦æ¢ä¹‹ä¸Š */
            /* åŠ å…¥å‹•ç•«æ•ˆæœ */
            animation: pulse-border 3s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
            50% { border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); }
            100% { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">ğŸƒâ€â™‚ï¸ å­¸ç”Ÿç’°å³¶è·‘æ­¥é‡Œç¨‹å„€ (çŸ©å½¢ç’°ç‹€è·‘é“ Beta 4) ğŸ‡¹ğŸ‡¼</h1>
            <p class="text-xl text-gray-600">è·‘æ­¥é€²åº¦è¦–è¦ºåŒ–ï¼šæ²¿è‘—çŸ©å½¢ç’°ç‹€è·‘é“é †æ™‚é‡ç¹è¡Œï¼</p>
            <p class="text-sm text-gray-500 mt-1">è™›æ“¬ç’°å³¶è·‘é“ä¸€åœˆç‚º <span class="font-bold text-red-500">50,000 å…¬å°º (50 å…¬é‡Œ)</span>ã€‚</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 1. è³‡æ–™è¼¸å…¥å€ -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl h-fit sticky top-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">è¼¸å…¥ä»Šæ—¥è·‘æ­¥ç´€éŒ„</h2>
                
                <div id="authStatus" class="text-sm font-semibold text-yellow-700 p-2 rounded-lg bg-yellow-100 mb-4">
                    âŒ› æ­£åœ¨é€£ç·šåˆ°è³‡æ–™åº«...
                </div>
                
                <form id="recordForm" class="space-y-4">
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">å§“å</label>
                        <input type="text" id="name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥å§“å">
                    </div>
                    
                    <div>
                        <label for="studentId" class="block text-sm font-medium text-gray-700">åº§è™Ÿ / ç·¨è™Ÿ</label>
                        <input type="text" id="studentId" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼š01 / A01">
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                        <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label for="laps" class="block text-sm font-medium text-gray-700">è·‘æ­¥åœˆæ•¸ (200 å…¬å°º/åœˆ)</label>
                        <input type="number" id="laps" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥å®Œæˆåœˆæ•¸">
                    </div>

                    <button type="submit" id="submitButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                        æäº¤ç´€éŒ„
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2">è³‡æ–™å°‡å„²å­˜æ–¼é›²ç«¯è³‡æ–™åº« (Firestore)ã€‚</p>
                </form>
                
                <!-- AI æ•™ç·´åˆ†æå€ -->
                <div class="mt-6 border-t pt-6">
                    <h2 class="text-xl font-bold text-purple-600 mb-3 flex items-center">
                        <span class="mr-2">ğŸ¤–</span> AI æ•™ç·´å¿ƒå¾—åˆ†æ
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">æ ¹æ“šæ‚¨è¼¸å…¥çš„åº§è™Ÿï¼ŒAI æ•™ç·´å°‡åˆ†ææ‚¨çš„ç´¯ç©é‡Œç¨‹ä¸¦æä¾›æ¿€å‹µæ€§å›é¥‹ï¼</p>
                    
                    <button type="button" id="generateReflectionButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200">
                        âœ¨ å–å¾— AI è·‘æ­¥å¿ƒå¾—
                    </button>

                    <div id="aiReflectionContent" class="mt-4 p-4 bg-purple-50 rounded-lg min-h-[50px] flex items-center justify-center">
                        <p class="text-gray-500 text-sm">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹åˆ†æ...</p>
                    </div>
                </div>

                <!-- é‡ç½®æ•¸æ“šæŒ‰éˆ• -->
                <div class="mt-6 border-t pt-6">
                    <button type="button" id="resetDataButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                        ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰æ•¸æ“š (éœ€ç®¡ç†è€…å¯†ç¢¼)
                    </button>
                    <p class="text-xs text-red-500 text-center mt-2">æ­¤ç‚º**æ°¸ä¹…æ“ä½œ**ï¼Œå°‡æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼</p>
                </div>
            </div>

            <!-- 2. è¦–è¦ºåŒ–åœ°åœ–å€ (è‰²å¡Šåœ°åœ–) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">ç’°å³¶é€²åº¦è¦–è¦ºåŒ– (çŸ©å½¢è·‘é“)</h2>
                
                <div class="flex flex-col gap-6 justify-center items-center">
                    
                    <!-- å°ç£æœ¬å³¶è‰²å¡Šåœ°åœ–ç¶²æ ¼ -->
                    <div id="taiwan-map-grid" class="w-full max-w-2xl aspect-[5/5]">
                        <!-- ä¸­å¤®ç«¶è³½ä¸»é¡Œæ’åœ– (3x3 å€å¡Š) -->
                        <div id="central-illustration" class="grid-center-area flex flex-col items-center justify-center p-4">
                            <!-- Trophy SVG (ä»£è¡¨ç«¶è³½èˆ‡ç›®æ¨™) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 fill-yellow-200">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                                <path d="M4 22h16"></path>
                                <path d="M10 14h4"></path>
                                <path d="M12 17v5"></path>
                                <path d="M12 12A6 6 0 0 0 5 8c0-1.5 1-4 2-5h10c1 1 2 3.5 2 5a6 6 0 0 0-7 4"></path>
                            </svg>
                            <p class="text-2xl font-black text-indigo-700 mt-2 text-center leading-tight">ç’°å³¶æŒ‘æˆ°è³½<br/>GO GO GO!</p>
                        </div>
                        <!-- ç¸£å¸‚æ–¹å¡Šå°‡ç”± JavaScript æ³¨å…¥æ­¤è™• -->
                    </div>

                    <!-- æ’è¡Œæ¦œ/ç¸½è¦½ -->
                    <div class="w-full p-4 bg-gray-50 rounded-xl shadow-md flex flex-col justify-start">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">ç¸½é‡Œç¨‹æ’è¡Œæ¦œ</h3>
                        <ul id="leaderboard" class="space-y-2">
                            <li class="p-3 text-gray-500 text-center">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</li>
                        </ul>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>

    <!-- è‡ªè¨‚è¨Šæ¯æ¡† (å–ä»£ alert) -->
    <div id="messageBox" class="fixed bottom-5 right-5 p-4 border rounded-lg shadow-xl z-50 transition-transform duration-300 transform translate-x-full" role="alert">
        <div class="flex items-center">
            <span id="messageIcon" class="text-xl mr-2"></span>
            <span id="messageContent" class="font-medium"></span>
            <button onclick="document.getElementById('messageBox').classList.add('translate-x-full')" class="ml-4 text-gray-500 hover:text-gray-700">&times;</button>
        </div>
    </div>
    
    <!-- è‡ªè¨‚ç¢ºèªå°è©±æ¡† (ç¾åœ¨åŒ…å«å¯†ç¢¼è¼¸å…¥) -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-lg mx-4 shadow-2xl transform transition-all scale-100">
            <h3 id="confirmTitle" class="text-2xl font-bold text-red-600 mb-4 border-b pb-2"></h3>
            <p id="confirmMessage" class="text-gray-700 mb-4 leading-relaxed"></p>
            
            <!-- å¯†ç¢¼è¼¸å…¥æ¬„ä½ (æ–°å¢) -->
            <div class="mb-6">
                <label for="adminPinInput" class="block text-sm font-medium text-gray-700 mb-2">ç®¡ç†è€…å¯†ç¢¼</label>
                <input type="password" id="adminPinInput" class="block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-red-500 focus:ring-red-500" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>

            <div class="flex justify-end space-x-4">
                <button id="cancelDeleteButton" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="confirmDeleteButton" class="px-6 py-2 border border-transparent rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors shadow-lg">
                    ç¢ºèªåˆªé™¤
                </button>
            </div>
        </div>
    </div>
</body>
</html>
