<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生環島跑步紀錄視覺化 (可點擊查詢歷程)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // ==== LLM API 配置 (更新為 Firebase Cloud Function URL) ====
        // ⚠️ 將此佔位符替換為您的 Firebase Cloud Function 部署後的實際 URL！
        // 格式通常為：https://<REGION>-<PROJECT_ID>.cloudfunctions.net/geminiProxy
        const PROXY_URL = "https://your-firebase-region-your-project-id.cloudfunctions.net/geminiProxy"; 
        
        // **** ⚠️ 管理者密碼設置 (移除硬編碼密碼) ⚠️ ****
        const ADMIN_PIN = "123456"; // 僅作為本地測試時的參考或移除。
        // **********************************************

        // ==== IMPORTANT: START Firebase Config (FOR GH Pages / Static Hosting) ====
        const GH_PAGES_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCuxRrZXNPrKWx9nrRiZyY_plxUkSISeFo",
            authDomain: "dyps-run.firebaseapp.com",
            projectId: "dyps-run",
            storageBucket: "dyps-run.firebasestorage.app",
            messagingSenderId: "691795460367",
            appId: "1:691795460367:web:fe6e2a323d1c4ff4bb3e7a",
            measurementId: "G-QHBBCYHYDP" 
        };
        // ==== IMPORTANT: END Firebase Config ====

        // ==== Global Variables (Adaptation for Static Hosting / Canvas) ====
        const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}';
        const firebaseConfig = isCanvasEnvironment 
            ? JSON.parse(__firebase_config) 
            : GH_PAGES_FIREBASE_CONFIG;
            
        const appId = isCanvasEnvironment 
            ? (typeof __app_id !== 'undefined' ? __app_id : 'default-running-app') 
            : 'beta4-gh-pages-running-app'; 

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Google 身份驗證提供者
        const googleProvider = new GoogleAuthProvider();

        // Constants 
        const LAPS_TO_METERS = 200; 
        const ISLAND_LAP_DISTANCE_M = 50000; 

        let currentUserId = null;
        let currentUserName = '訪客'; // 儲存登入者的名稱或 Email
        let authReady = false; 
        let studentTotalsData = {}; 
        let listenerActive = false; 
        
        // 台灣本島縣市資料 (保持不變)
        const CITIES_DATA = [
            // 第一段：南邊海岸線 (右至左/東至西) - 視覺上應往左移動
            { id: 'tainan', name: '台南市', grid: 'col-start-5 row-start-5', color: 'bg-green-600', direction: 'left' }, 
            { id: 'kaohsiung', name: '高雄市', grid: 'col-start-4 row-start-5', color: 'bg-zinc-600', direction: 'left' },
            { id: 'pingtung', name: '屏東縣', grid: 'col-start-3 row-start-5', color: 'bg-teal-600', direction: 'left' },
            { id: 'taitung', name: '台東縣', grid: 'col-start-2 row-start-5', color: 'bg-cyan-600', direction: 'left' },
            { id: 'hualien', name: '花蓮縣', grid: 'col-start-1 row-start-5', color: 'bg-sky-400', direction: 'up' }, // 轉角

            // 第二段：東邊海岸線 (底至上/南至北) - 視覺上應往上移動
            { id: 'yilan', name: '宜蘭縣', grid: 'col-start-1 row-start-4', color: 'bg-lime-500', direction: 'up' },
            { id: 'keelung', name: '基隆市', grid: 'col-start-1 row-start-3', color: 'bg-emerald-500', direction: 'up' },
            { id: 'newtaipei', name: '新北市', grid: 'col-start-1 row-start-2', color: 'bg-pink-500', direction: 'up' },
            { id: 'taipei', name: '台北市', grid: 'col-start-1 row-start-1', color: 'bg-red-500', direction: 'right' }, // 轉角

            // 第三段：北邊海岸線 (左至右/西至東) - 視覺上應往右移動
            { id: 'taoyuan', name: '桃園市', grid: 'col-start-2 row-start-1', color: 'bg-yellow-400', direction: 'right' },
            { id: 'hsinchucty', name: '新竹縣', grid: 'col-start-3 row-start-1', color: 'bg-teal-500', direction: 'right' },
            { id: 'miaoli', name: '苗栗縣', grid: 'col-start-4 row-start-1', color: 'bg-purple-500', direction: 'right' },
            { id: 'taichung', name: '台中市', grid: 'col-start-5 row-start-1', color: 'bg-orange-500', direction: 'down' }, // 轉角

            // 第四段：西邊海岸線 (上至下/北至南) - 視覺上應往下移動
            { id: 'changhua', name: '彰化縣', grid: 'col-start-5 row-start-2', color: 'bg-rose-500', direction: 'down' },
            { id: 'yunlin', name: '雲林縣', grid: 'col-start-5 row-start-3', color: 'bg-fuchsia-600', direction: 'down' }, 
            { id: 'chiayicty', name: '嘉義縣', grid: 'col-start-5 row-start-4', color: 'bg-pink-400', direction: 'down' }, // 嘉義縣作為折返點前一站
        ];
        
        const TAIWAN_PATH_POINTS = [
            { id: 'tainan', name: '台南市', progress: 0.0000 },
            { id: 'kaohsiung', name: '高雄市', progress: 0.0625 },
            { id: 'pingtung', name: '屏東縣', progress: 0.1250 },
            { id: 'taitung', name: '台東縣', progress: 0.1875 },
            { id: 'hualien', name: '花蓮縣', progress: 0.2500 },
            { id: 'yilan', name: '宜蘭縣', progress: 0.3125 },
            { id: 'keelung', name: '基隆市', progress: 0.3750 },
            { id: 'newtaipei', name: '新北市', progress: 0.4375 },
            { id: 'taipei', name: '台北市', progress: 0.5000 },
            { id: 'taoyuan', name: '桃園市', progress: 0.5625 },
            { id: 'hsinchucty', name: '新竹縣', progress: 0.6250 },
            { id: 'miaoli', name: '苗栗縣', progress: 0.6875 },
            { id: 'taichung', name: '台中市', progress: 0.7500 },
            { id: 'changhua', name: '彰化縣', progress: 0.8125 },
            { id: 'yunlin', name: '雲林縣', progress: 0.8750 },
            { id: 'chiayicty', name: '嘉義縣', progress: 0.9375 },
            { id: 'tainan_end', name: '回到台南', progress: 1.0000 },
        ];
        
        // ==== Color Utility Functions (保持不變) ====
        function getColorHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        function getTextColor(hexcolor) {
            const r = parseInt(hexcolor.substring(1, 3), 16);
            const g = parseInt(hexcolor.substring(3, 5), 16);
            const b = parseInt(hexcolor.substring(5, 7), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return (brightness > 150) ? 'black' : 'white';
        }

        function darkenColor(hex, factor = 0.7) {
            let r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);

            r = Math.floor(r * factor);
            g = Math.floor(g * factor);
            b = Math.floor(b * factor);

            r = Math.max(0, Math.min(255, r));
            g = Math.max(0, Math.min(255, g));
            b = Math.max(0, Math.min(255, b));

            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).padStart(6, '0')}`;
        }
        
        // ==== Local Storage Functions (Input Persistence) ====
        
        function saveIdentity(studentId) {
            try {
                // 姓名由 Google 帳號提供，不再儲存姓名
                localStorage.setItem('studentId', studentId);
            } catch (e) {
                console.warn("無法使用 localStorage 儲存身份。請檢查瀏覽器設定。", e);
            }
        }

        function loadIdentity() {
            try {
                const studentId = localStorage.getItem('studentId');
                const studentIdSelect = document.getElementById('studentId');

                // 僅載入座號到新的下拉選單
                if (studentId && studentIdSelect) {
                    // 確保載入的值存在於選項中
                    const optionExists = Array.from(studentIdSelect.options).some(option => option.value === studentId);
                    if (optionExists) {
                        studentIdSelect.value = studentId;
                    }
                }
            } catch (e) {
                console.warn("無法從 localStorage 載入身份。", e);
            }
        }
        
        /**
         * 填充 1 到 30 的座號下拉式選單
         */
        function populateStudentIdDropdown() {
            const select = document.getElementById('studentId');
            if (!select) return;

            select.innerHTML = '<option value="" disabled selected>請選擇座號</option>';

            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                const studentIdValue = i.toString().padStart(2, '0'); // 格式化為 01, 02...
                option.value = studentIdValue;
                option.textContent = `${i} 號 (${studentIdValue})`;
                select.appendChild(option);
            }
        }


        // ==== Firestore & Auth Functions ====
        
        const getCollectionRef = () => {
            return collection(db, `artifacts/${appId}/public/data/running_records`);
        };

        // 更新 UI 狀態以反映 Google 登入狀態
        function updateAuthStatusUI() {
            const statusElement = document.getElementById('authStatus');
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const recordFormDiv = document.getElementById('recordFormDiv'); 
            const nameInput = document.getElementById('name');
            
            if (authReady && currentUserId) {
                // 已登入
                statusElement.textContent = `✅ 已登入為：${currentUserName} (ID: ${currentUserId.substring(0, 8)}...)`;
                statusElement.className = 'text-sm font-semibold text-green-700 p-2 rounded-lg bg-green-100 mb-4';
                
                signInButton.classList.add('hidden');
                signOutButton.classList.remove('hidden');
                recordFormDiv.classList.remove('hidden'); 
                document.getElementById('currentUserNameSpan').textContent = currentUserName;
                nameInput.value = currentUserName; // ⭐️ 自動填寫姓名
            } else if (authReady && !currentUserId) {
                // 未登入/登出
                statusElement.textContent = '🔒 請使用 Google 帳號登入以提交您的跑步紀錄。';
                statusElement.className = 'text-sm font-semibold text-blue-700 p-2 rounded-lg bg-blue-100 mb-4';
                
                signInButton.classList.remove('hidden');
                signOutButton.classList.add('hidden');
                recordFormDiv.classList.add('hidden'); 
                document.getElementById('currentUserNameSpan').textContent = '訪客';
                nameInput.value = ''; // ⭐️ 清空姓名
            } else {
                // 正在連線
                statusElement.textContent = '⌛ 正在連線到資料庫...';
                statusElement.className = 'text-sm font-semibold text-yellow-700 p-2 rounded-lg bg-yellow-100 mb-4';
                
                signInButton.classList.add('hidden');
                signOutButton.classList.add('hidden');
                recordFormDiv.classList.add('hidden'); 
            }
        }
        
        // Google 登入功能
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                // 登入成功，onAuthStateChanged 會自動處理後續流程
                showMessageBox(`歡迎，${result.user.displayName || result.user.email}！您已成功登入。`, "success");
            } catch (error) {
                console.error("Google Sign-in Failed:", error);
                showMessageBox(`❌ Google 登入失敗: ${error.message}. 請稍後再試。`, "error");
            }
        }
        
        // 登出功能
        async function handleSignOut() {
             try {
                await signOut(auth);
                showMessageBox("您已成功登出。", "info");
            } catch (error) {
                console.error("Sign-out Failed:", error);
                showMessageBox(`❌ 登出失敗: ${error.message}`, "error");
            }
        }

        /**
         * 啟動 Firebase 身份驗證狀態監聽
         */
        function initAuthAndListener() {
            const nameInput = document.getElementById('name');
            onAuthStateChanged(auth, (user) => {
                authReady = true; 
                
                if (user) {
                    currentUserId = user.uid;
                    currentUserName = user.displayName || user.email; // 使用 Google 帳號的名稱或 email
                    nameInput.value = currentUserName; // ⭐️ 修正：確保登入時更新
                    
                    if (!listenerActive) {
                        setupRealtimeListener();
                        listenerActive = true;
                    }
                } else {
                    currentUserId = null;
                    currentUserName = '訪客';
                    nameInput.value = ''; // ⭐️ 修正：確保登出時清空
                    listenerActive = false; 

                    // 登出時清空排行榜
                    const leaderboard = document.getElementById('leaderboard');
                    if (leaderboard) {
                        leaderboard.innerHTML = '<li class="p-3 text-gray-500 text-center">請先登入以查看排行榜。</li>';
                        updateMap([]);
                    }
                }
                updateAuthStatusUI(); // 統一更新 UI
            });
        }
        
        // ==== 數據刪除核心功能 (保持不變) ====
        async function deleteAllRecords() {
            const recordsRef = getCollectionRef();
            const q = query(recordsRef);
            
            try {
                const snapshot = await getDocs(q); 
                const batchSize = snapshot.docs.length;

                if (batchSize === 0) {
                    showMessageBox("目前沒有數據需要清除。", "info");
                    return;
                }
                
                const deleteButton = document.getElementById('confirmDeleteButton');
                const originalText = deleteButton.textContent;
                
                deleteButton.disabled = true;
                deleteButton.textContent = `🧹 正在清除 ${batchSize} 筆數據...`;

                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));

                await Promise.all(deletePromises);
                
                showMessageBox(`✅ 成功清除所有 ${batchSize} 筆跑步紀錄。`, "success");
                
            } catch (error) {
                console.error("Error deleting all documents: ", error);
                showMessageBox(`❌ 清除數據失敗 (錯誤: ${error.code || error.message})`, "error");
            } finally {
                const deleteButton = document.getElementById('confirmDeleteButton');
                deleteButton.disabled = false;
                deleteButton.textContent = '確認刪除';
                closeConfirmationModal();
            }
        }

        function resetDataHandler() {
            showConfirmationModal(
                "⚠️ 管理者數據清除", 
                "此操作將**永久刪除**應用程式中所有學生的跑步紀錄！清除後無法復原。請輸入管理者密碼繼續。", 
                () => {
                    const pinInput = document.getElementById('adminPinInput');
                    const enteredPin = pinInput.value.trim();
                    pinInput.value = ''; 
                    
                    if (enteredPin === ADMIN_PIN) {
                        deleteAllRecords();
                    } else {
                        showMessageBox("❌ 密碼錯誤！無法執行數據清除。", "error");
                        closeConfirmationModal(); 
                    }
                }
            );
        }

        // ==== DOMContentLoaded / Init ====
        document.addEventListener('DOMContentLoaded', () => {
            
            // ⭐️ 新增：生成下拉選單
            populateStudentIdDropdown();

            const form = document.getElementById('recordForm');
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            form.addEventListener('submit', handleFormSubmit);
            
            loadIdentity(); 
            
            const resetButton = document.getElementById('resetDataButton');
            resetButton.addEventListener('click', resetDataHandler);

            const generateButton = document.getElementById('generateReflectionButton');
            generateButton.addEventListener('click', (e) => {
                e.preventDefault();
                
                if (!currentUserId) {
                     showMessageBox("請先登入才能取得個人化 AI 心得。", "info");
                     return;
                }
                // 姓名來自唯讀欄位，座號來自下拉選單
                const name = document.getElementById('name').value.trim();
                const studentId = document.getElementById('studentId').value.trim();
                
                if (!name || !studentId) {
                    showMessageBox("請確保您已登入並選擇座號，才能取得個人化 AI 心得。", "info");
                    return;
                }
                
                generateReflection(name, studentId);
            });
            
            // 登入/登出按鈕監聽器
            document.getElementById('signInButton').addEventListener('click', signInWithGoogle);
            document.getElementById('signOutButton').addEventListener('click', handleSignOut);
            
            document.getElementById('confirmDeleteButton').addEventListener('click', () => {
                const callback = window.currentConfirmationCallback;
                if (callback && typeof callback === 'function') {
                    callback();
                } else {
                    closeConfirmationModal(); 
                }
            });

            document.getElementById('cancelDeleteButton').addEventListener('click', closeConfirmationModal);
            
            document.getElementById('closeHistoryModalButton').addEventListener('click', closeHistoryModal);

            buildBlockMap();

            initAuthAndListener(); // 啟動監聽和登入流程
        });
        
        /**
         * 動態生成縣市色塊地圖 (保持不變)
         */
        function buildBlockMap() {
            const mapGrid = document.getElementById('taiwan-map-grid');
            mapGrid.innerHTML = `
                <!-- 中央競賽主題插圖 (3x3 區塊) -->
                <div id="central-illustration" class="grid-center-area flex flex-col items-center justify-center p-4">
                    <!-- Trophy SVG (代表競賽與目標) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 fill-yellow-200">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                        <path d="M4 22h16"></path>
                        <path d="M10 14h4"></path>
                        <path d="M12 17v5"></path>
                        <path d="M12 12A6 6 0 0 0 5 8c0-1.5 1-4 2-5h10c1 1 2 3.5 2 5a6 6 0 0 0-7 4"></path>
                    </svg>
                    <p class="text-2xl font-black text-indigo-700 mt-2 text-center leading-tight">環島挑戰賽<br/>GO GO GO!</p>
                </div>
            `; 
            
            CITIES_DATA.forEach(region => {
                const block = document.createElement('div');
                block.id = `block-${region.id}`;
                block.className = `city-block ${region.grid} ${region.color} relative`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = region.name;
                nameSpan.className = 'text-center z-10';

                const markerContainer = document.createElement('div');
                markerContainer.id = `marker-container-${region.id}`;
                markerContainer.className = 'absolute inset-0 pointer-events-none z-20';

                block.appendChild(nameSpan);
                block.appendChild(markerContainer);
                mapGrid.appendChild(block);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentUserId) {
                showMessageBox("請先使用 Google 帳號登入才能提交紀錄。", "error");
                return;
            }
            
            // ⭐️ 姓名來自唯讀欄位，座號來自下拉選單
            const name = document.getElementById('name').value.trim(); 
            const studentId = document.getElementById('studentId').value.trim();
            const date = document.getElementById('date').value;
            const laps = parseInt(document.getElementById('laps').value, 10);

            if (!name || !studentId || !date || isNaN(laps) || laps <= 0) {
                showMessageBox("請確保您已登入、選擇座號，且所有欄位都已正確填寫，圈數大於 0。", "info");
                return;
            }
            
            saveIdentity(studentId); // 僅儲存座號
            
            const distanceMeters = laps * LAPS_TO_METERS;

            const record = {
                name: name,
                studentId: studentId,
                date: date,
                laps: laps,
                distanceMeters: distanceMeters,
                submittedBy: currentUserId, 
                timestamp: serverTimestamp()
            };

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = '儲存中...';

            try {
                await addDoc(getCollectionRef(), record);
                showMessageBox("跑步紀錄已成功儲存！", "success");
                document.getElementById('laps').value = '';
                
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox(`儲存紀錄失敗 (錯誤: ${error.code || error.message})`, "error");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '提交紀錄';
            }
        }
        
        function getCityInfoByProgress(progress) {
            const currentProgress = progress % 1.0; 
            
            for (let i = 0; i < TAIWAN_PATH_POINTS.length - 1; i++) {
                const p1 = TAIWAN_PATH_POINTS[i];
                const p2 = TAIWAN_PATH_POINTS[i + 1];

                if (currentProgress >= p1.progress && currentProgress < p2.progress) {
                    const segmentLength = p2.progress - p1.progress;
                    const progressInCity = (currentProgress - p1.progress) / segmentLength; 
                    
                    return {
                        cityId: p1.id,
                        cityName: p1.name.replace(/\/.*/, '').replace('回到', ''),
                        progressInCity: progressInCity
                    };
                }
            }
            
            if (currentProgress === 0.0 && progress > 0) {
                 const startCity = TAIWAN_PATH_POINTS[0];
                 return {
                    cityId: startCity.id,
                    cityName: startCity.name.replace(/\/.*/, '').replace('回到', ''),
                    progressInCity: 1.0 
                };
            }
            
            const startCity = TAIWAN_PATH_POINTS[0];
            return {
                cityId: startCity.id,
                cityName: startCity.name.replace(/\/.*/, '').replace('回到', ''),
                progressInCity: 0.0
            };
        }

        /**
         * 🚨 修正 AI 教練功能：改為呼叫 Cloud Function 代理服務 (使用指數退避重試)
         */
        async function generateReflection(studentName, studentId) {
            if (!currentUserId) {
                 showMessageBox("請先登入才能使用 AI 教練功能。", "info");
                 return;
            }
            
            if (PROXY_URL.includes("your-firebase-region-your-project-id")) {
                 showMessageBox("❌ Cloud Function URL 尚未配置！請先部署 Firebase 代理服務並更新 PROXY_URL。", "error");
                 return;
            }

            const reflectionBox = document.getElementById('aiReflectionContent');
            const generateButton = document.getElementById('generateReflectionButton');

            const student = studentTotalsData[studentId];
            if (!student) {
                reflectionBox.innerHTML = '<p class="text-red-500">❌ 找不到該座號的跑步紀錄。請先提交至少一次紀錄。</p>';
                return;
            }

            generateButton.disabled = true;
            generateButton.innerHTML = '✨ 正在產生心得...';
            reflectionBox.innerHTML = '<p class="text-gray-500 animate-pulse">正在與 AI 教練連線，請稍候...</p>';
            
            const totalDistance = student.totalDistanceM;
            const totalKm = (totalDistance / 1000).toFixed(2);
            const fullLaps = Math.floor(totalDistance / ISLAND_LAP_DISTANCE_M);
            const currentLapProgress = (totalDistance % ISLAND_LAP_DISTANCE_M) / ISLAND_LAP_DISTANCE_M;
            
            const cityInfo = getCityInfoByProgress(currentLapProgress);
            const location = cityInfo.cityName;
            const progressInCityPercent = (cityInfo.progressInCity * 100).toFixed(0);

            const nextLapKm = ((fullLaps + 1) * ISLAND_LAP_DISTANCE_M / 1000).toFixed(2);

            const systemPrompt = "你是一位充滿活力且富有洞察力的學生體育教練。根據學生在虛擬環島跑道上的總里程和進度，以繁體中文撰寫一份簡短、具激勵性且個性化的跑步分析或心得。重點鼓勵他們的努力並提及他們所在的大概地理位置。限制在三到四句話內。";

            const userQuery = `請為學生 ${studentName} (座號 ${studentId}) 撰寫心得。他們目前總里程為 ${totalKm} 公里。已完成 ${fullLaps} 次環島。在當前環島進度中，他們正位於 ${location}，進度約 ${progressInCityPercent}%。下一個完整環島里程碑是 ${nextLapKm} 公里。請專注於鼓勵和分析。`;

            // 呼叫代理服務的請求體
            const proxyPayload = {
                userQuery: userQuery,
                systemPrompt: systemPrompt,
            };

            const maxRetries = 3;
            let resultText = '';
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxyPayload)
                    });
                    
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`代理服務錯誤! 狀態: ${response.status}. 內容: ${errorBody.substring(0, 100)}...`);
                    }

                    const result = await response.json();
                    
                    const candidateText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (candidateText) {
                        resultText = candidateText;
                        break; 
                    } else if (result.error) {
                         throw new Error(`AI 請求失敗: ${result.error.message || '未知錯誤'}`);
                    } else {
                         console.warn("Proxy returned 200 OK but no text content:", JSON.stringify(result, null, 2));
                         throw new Error("AI 回覆內容遺失。");
                    }

                } catch (error) {
                    lastError = error.message;
                    console.error(`第 ${i + 1} 次嘗試失敗:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        resultText = `很抱歉，AI 教練連線失敗，請稍後再試。 (錯誤訊息: ${lastError})`;
                    }
                }
            }

            if (resultText) {
                 reflectionBox.innerHTML = `<p class="text-gray-700 leading-relaxed italic border-l-4 border-indigo-400 pl-4">${resultText}</p>`;
            } else {
                 reflectionBox.innerHTML = `<p class="text-red-500">AI 教練未能產生心得。請檢查網路連線或稍後再試。 (最後錯誤: ${lastError})</p>`;
            }

            generateButton.disabled = false;
            generateButton.innerHTML = '✨ 取得 AI 跑步心得';
        }
        
        /**
         * 啟動即時監聽器，從 Firestore 獲取所有數據。 (保持不變)
         */
        function setupRealtimeListener() {
            if (!currentUserId && listenerActive) {
                return;
            }

            const recordsQuery = query(getCollectionRef()); 
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '<li class="p-3 text-gray-500 text-center animate-pulse">🏃 正在從雲端載入數據...</li>';

            onSnapshot(recordsQuery, (snapshot) => {
                const allRecords = [];
                snapshot.forEach((doc) => {
                    allRecords.push(doc.data());
                });
                processRecords(allRecords);
            }, (error) => {
                console.error("Error listening to running records:", error);
                showMessageBox("無法連接到資料庫或權限不足。無法顯示排行榜。", "error");
            });
            listenerActive = true; 
        }

        function processRecords(records) {
            const studentTotals = {};
            const leaderboard = document.getElementById('leaderboard');
            
            leaderboard.innerHTML = ''; 
            
            records.forEach(record => {
                const key = record.studentId;
                if (!studentTotals[key]) {
                    studentTotals[key] = {
                        name: record.name,
                        studentId: key,
                        totalDistanceM: 0,
                        records: [] 
                    };
                }
                const distance = typeof record.distanceMeters === 'number' ? record.distanceMeters : 0;
                studentTotals[key].totalDistanceM += distance; 
                studentTotals[key].records.push(record); 
            });
            
            studentTotalsData = studentTotals;
            
            let students = Object.values(studentTotals);
            
            if (students.length === 0) {
                 leaderboard.innerHTML = '<li class="p-3 text-gray-500 text-center">目前沒有任何跑步紀錄。請提交您的第一筆紀錄！</li>';
                 updateMap([]); 
                 return;
            }
            
            students.sort((a, b) => b.totalDistanceM - a.totalDistanceM);

            students.forEach((student, index) => {
                const totalKm = (student.totalDistanceM / 1000).toFixed(2);
                const li = document.createElement('li');
                li.className = 'p-3 bg-white/70 backdrop-blur-sm rounded-xl flex justify-between items-center shadow-md mb-2 transition-all duration-300 hover:shadow-lg cursor-pointer';
                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg w-6 text-center text-indigo-600">${index + 1}</span>
                        <span class="text-gray-800 font-medium truncate">${student.name} (${student.studentId})</span>
                    </div>
                    <span class="font-mono text-xl text-green-700">${totalKm} KM</span>
                `;
                li.addEventListener('click', () => showHistoryModal(student.studentId)); 
                leaderboard.appendChild(li);
            });
            
            updateMap(students);
        }

        function updateMap(students) {
            // 1. 清除舊的標記和進度條 (保持不變)
            CITIES_DATA.forEach(city => {
                const container = document.getElementById(`marker-container-${city.id}`);
                if (container) {
                    container.innerHTML = '';
                }
                const cityBlock = document.getElementById(`block-${city.id}`);
                const existingBars = cityBlock ? cityBlock.querySelectorAll('.progress-bar-student') : [];
                existingBars.forEach(bar => bar.remove());
            });

            const barThickness = '4px';

            students.forEach(student => {
                const totalDistance = student.totalDistanceM;
                const fullLaps = Math.floor(totalDistance / ISLAND_LAP_DISTANCE_M);
                const currentLapProgress = (totalDistance % ISLAND_LAP_DISTANCE_M) / ISLAND_LAP_DISTANCE_M;
                
                const { cityId, progressInCity } = getCityInfoByProgress(currentLapProgress);
                const cityData = CITIES_DATA.find(c => c.id === cityId);
                
                if (!cityData) return;
                const direction = cityData.direction;

                const cityBlock = document.getElementById(`block-${cityId}`);
                const container = document.getElementById(`marker-container-${cityId}`);
                
                if (!cityBlock || !container) return; 

                // 2. 進度條 (Progress Bar) (保持不變)
                let progressBar = document.getElementById(`progress-bar-${student.studentId}`);
                
                if (progressBar && progressBar.parentElement !== cityBlock) {
                    progressBar.parentElement.removeChild(progressBar);
                    progressBar = null; 
                }
                
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.id = `progress-bar-${student.studentId}`;
                    progressBar.className = 'absolute transition-all duration-1000 ease-out z-0 opacity-80 progress-bar-student rounded-sm';
                    cityBlock.appendChild(progressBar);
                }
                
                progressBar.style.top = '';
                progressBar.style.bottom = '';
                progressBar.style.left = '';
                progressBar.style.right = '';
                progressBar.style.width = '';
                progressBar.style.height = ''; 
                progressBar.style.transform = ''; 

                const progressPercent = `${progressInCity * 100}%`;
                const color = getColorHash(student.studentId);
                
                progressBar.style.backgroundColor = color; 
                
                switch (direction) {
                    case 'right': 
                    case 'left': 
                        progressBar.style.top = '50%';
                        progressBar.style.height = barThickness;
                        progressBar.style.width = progressPercent;
                        progressBar.style.transform = 'translateY(-50%)'; 
                        if (direction === 'right') {
                            progressBar.style.left = '0';
                        } else { // 'left'
                            progressBar.style.right = '0'; 
                        }
                        break;
                    case 'up': 
                    case 'down': 
                        progressBar.style.left = '50%';
                        progressBar.style.width = barThickness;
                        progressBar.style.height = progressPercent;
                        progressBar.style.transform = 'translateX(-50%)'; 
                        if (direction === 'up') {
                            progressBar.style.bottom = '0';
                        } else { // 'down'
                            progressBar.style.top = '0'; 
                        }
                        break;
                }
                
                // 3. 標記 (Marker) (保持不變)
                const markerPosition = `${progressInCity * 100}%`; 
                const borderColor = darkenColor(color, 0.7); 
                
                let marker = document.getElementById(`marker-${student.studentId}`);
                if (!marker) {
                    marker = document.createElement('div');
                    marker.id = `marker-${student.studentId}`;
                    marker.className = `student-marker absolute px-2 h-6 rounded-full shadow-lg border-2 flex items-center justify-center font-bold text-xs whitespace-nowrap transition-all duration-1000 ease-out z-30 cursor-pointer`; 
                    marker.addEventListener('click', () => showHistoryModal(student.studentId));
                    container.appendChild(marker); 
                }
                
                marker.style.top = '';
                marker.style.left = '';
                marker.style.right = '';
                marker.style.bottom = '';
                marker.style.transform = ''; 

                marker.style.backgroundColor = color; 
                marker.style.borderColor = borderColor; 
                marker.style.color = getTextColor(color);
                marker.title = `${student.name} (${student.studentId})：總里程 ${(totalDistance / 1000).toFixed(2)} KM (已完成 ${fullLaps} 次環島)。點擊查看歷程。`;
                marker.textContent = student.name; 
                
                switch (direction) {
                    case 'right': 
                        marker.style.top = '50%';
                        marker.style.left = markerPosition; 
                        marker.style.transform = 'translate(-50%, -50%)'; 
                        break;
                    case 'left': 
                        marker.style.top = '50%'; 
                        marker.style.right = markerPosition;
                        marker.style.transform = 'translate(50%, -50%)'; 
                        break;
                    case 'up': 
                        marker.style.left = '50%'; 
                        marker.style.bottom = markerPosition; 
                        marker.style.transform = 'translate(-50%, 50%)'; 
                        break;
                    case 'down': 
                        marker.style.left = '50%'; 
                        marker.style.top = markerPosition; 
                        marker.style.transform = 'translate(-50%, -50%)'; 
                        break;
                }
                
                if (marker.parentElement !== container) {
                    container.appendChild(marker);
                }
            });
        }
        
        /**
         * 🚨 新增功能：顯示學生的跑步歷史紀錄彈窗 (保持不變)
         */
        function showHistoryModal(studentId) {
            const student = studentTotalsData[studentId];
            if (!student) {
                showMessageBox("查無該學生的紀錄。", "error");
                return;
            }

            const modal = document.getElementById('historyModal');
            const recordsList = document.getElementById('historyRecordsList');

            const sortedRecords = student.records.sort((a, b) => {
                if (a.timestamp && b.timestamp && typeof a.timestamp.toDate === 'function' && typeof b.timestamp.toDate === 'function') {
                    return b.timestamp.toDate() - a.timestamp.toDate();
                }
                return new Date(b.date) - new Date(a.date);
            });

            document.getElementById('historyTitle').textContent = `${student.name} (${student.studentId}) 跑步歷程`;
            document.getElementById('historyTotal').textContent = `總里程: ${(student.totalDistanceM / 1000).toFixed(2)} KM`;

            recordsList.innerHTML = '';
            if (sortedRecords.length === 0) {
                 recordsList.innerHTML = '<li class="text-center text-gray-500">此學生目前沒有跑步紀錄。</li>';
            } else {
                 sortedRecords.forEach(record => {
                    let submissionTime = '';
                    if (record.timestamp && typeof record.timestamp.toDate === 'function') {
                        submissionTime = record.timestamp.toDate().toLocaleTimeString('zh-TW', { 
                            hour: '2-digit', minute: '2-digit', hour12: false 
                        });
                        submissionTime = `${record.date} ${submissionTime}`; 
                    } else {
                        submissionTime = record.date; 
                    }
                    
                    const distanceKm = (record.distanceMeters / 1000).toFixed(2);

                    const li = document.createElement('li');
                    li.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 border-b border-gray-100 hover:bg-indigo-50 transition-colors rounded-lg mb-1';
                    li.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-gray-800">${record.date} 紀錄</span>
                            <span class="text-xs text-gray-500">圈數: ${record.laps} (提交於: ${submissionTime})</span>
                        </div>
                        <span class="text-lg font-bold text-indigo-600 sm:mt-0 mt-1">${distanceKm} KM</span>
                    `;
                    recordsList.appendChild(li);
                });
            }


            modal.classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }
        
        /**
         * 顯示浮動訊息框，並在 8 秒後自動隱藏。 (保持不變)
         */
        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('messageBox');
            const content = document.getElementById('messageContent');
            const icon = document.getElementById('messageIcon');
            const boxClasses = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700'
            };
            const iconContent = {
                success: '✅',
                error: '❌',
                info: 'ℹ️'
            };

            const baseClasses = 'fixed bottom-5 right-5 p-4 border rounded-lg shadow-xl z-50 transition-transform duration-300 transform';
            
            box.className = `${baseClasses} translate-x-full ${boxClasses[type]}`;
            
            icon.textContent = iconContent[type];
            content.textContent = message;

            void box.offsetWidth; 

            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                box.classList.remove('translate-x-0');
                box.classList.add('translate-x-full');
            }, 8000); 
        }
        
        function showConfirmationModal(title, message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').innerHTML = message;
            
            window.currentConfirmationCallback = callback; 
            
            modal.classList.remove('hidden');
            const pinInput = document.getElementById('adminPinInput');
            pinInput.value = '';
            setTimeout(() => pinInput.focus(), 100);
        }

        function closeConfirmationModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            window.currentConfirmationCallback = null;
        }

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* 色塊地圖網格容器 */
        #taiwan-map-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr)); 
            grid-template-rows: repeat(5, minmax(80px, 1fr));
            gap: 4px;
            background-color: #ecf0f1; 
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            height: auto;
            overflow: hidden;
        }
        
        /* 定義每個縣市方塊的共同樣式 */
        .city-block {
            @apply p-2 text-white font-bold text-base flex items-center justify-center shadow-inner transition-all duration-300 ease-in-out cursor-default;
            border: 2px solid rgba(255, 255, 255, 0.6);
            min-height: 80px; 
            overflow: hidden;
        }

        .city-block > span {
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
        }
        
        /* 中央競賽主題區塊 CSS */
        .grid-center-area {
            grid-column: 2 / 5;
            grid-row: 2 / 5;   
            background-color: #ffffff;
            border: 4px dashed #6366f1;
            border-radius: 1rem;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            z-index: 5;
            animation: pulse-border 3s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
            50% { border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); }
            100% { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
        }
        
        /* 確保學生標記的邊框樣式可以被行內 style 覆蓋 */
        .student-marker {
            /* 預設邊框 (寬度和樣式) */
            border-style: solid; 
            border-width: 2px;
            /* 邊框顏色將由 JS 的 marker.style.borderColor 覆蓋 */
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">🏃‍♂️ 學生環島跑步里程儀 (Google 登入版) 🇹🇼</h1>
            <p class="text-xl text-gray-600">跑步進度視覺化：沿著矩形環狀跑道順時針繞行！</p>
            <p class="text-sm text-gray-500 mt-1">虛擬環島跑道一圈為 <span class="font-bold text-red-500">50,000 公尺 (50 公里)</span>。</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 1. 資料輸入區 -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl h-fit sticky top-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">身份驗證與紀錄輸入</h2>
                
                <div id="authStatus" class="text-sm font-semibold text-yellow-700 p-2 rounded-lg bg-yellow-100 mb-4">
                    ⌛ 正在連線到資料庫...
                </div>
                
                <!-- 登入/登出按鈕 -->
                <button type="button" id="signInButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 hidden mb-3">
                    <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#FFC107" d="M43.6 20.4H24v7.5h11.3c-.7 4.2-4 8-9.3 8-6 0-10.9-4.9-10.9-10.9S14.7 14.1 20.7 14.1c3.2 0 5.8 1.4 7.7 3.2l5.7-5.7C30.6 6.8 25.8 4 20.7 4 11.2 4 3.4 11.8 3.4 21.3s7.8 17.3 17.3 17.3c9.9 0 17.1-7.1 17.1-17.1 0-1.1-.1-2.2-.4-3.3z"></path>
                        <path fill="#FF3D00" d="M6.3 18.5l6.3 4.9C14.7 20 17.5 18.5 20.7 18.5c3.2 0 5.8 1.4 7.7 3.2l5.7-5.7c-2-1.9-4.6-3.2-7.7-3.2C13.2 12.8 8.8 15.3 6.3 18.5z"></path>
                        <path fill="#4CAF50" d="M20.7 41.6c-5.1 0-9.5-2.5-12.2-6.4l6.3-4.9c1.9 2.8 4.9 4.6 8.7 4.6 4.7 0 8.6-3.1 10-7.2h6.8c-1.3 5.3-6.2 9.2-13.6 9.2z"></path>
                        <path fill="#1976D2" d="M43.6 20.4H24v7.5h11.3c-.7 4.2-4 8-9.3 8-3.8 0-7.2-1.8-9.4-4.6l-6.3 4.9c4 6.3 10.9 9.8 17.6 9.8 11.2 0 19.8-7.9 19.8-17.6 0-1.1-.1-2.2-.4-3.3z"></path>
                    </svg>
                    使用 Google 帳號登入
                </button>
                <button type="button" id="signOutButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200 hidden mb-3">
                    👋 登出 (目前身份: <span id="currentUserNameSpan">訪客</span>)
                </button>
                
                <!-- 紀錄表單 (未登入時隱藏) -->
                <div id="recordFormDiv" class="space-y-4 hidden">
                    <form id="recordForm" class="space-y-4">
                        <p class="text-sm text-gray-600 border-t pt-3">請確保資料正確，以利數據累積和計算。</p>
                        
                        <!-- ⭐️ 姓名 (Readonly) -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">姓名 (由登入帳號自動填寫)</label>
                            <input type="text" id="name" required readonly class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 bg-gray-100 text-gray-600 focus:outline-none">
                        </div>
                        
                        <!-- ⭐️ 座號 (Dropdown Select) -->
                        <div>
                            <label for="studentId" class="block text-sm font-medium text-gray-700">座號 / 編號 (1-30)</label>
                            <select id="studentId" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 bg-white">
                                <!-- Options will be generated by JavaScript -->
                            </select>
                        </div>

                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">日期</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                        </div>

                        <div>
                            <label for="laps" class="block text-sm font-medium text-gray-700">跑步圈數 (200 公尺/圈)</label>
                            <input type="number" id="laps" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="請輸入完成圈數">
                        </div>

                        <button type="submit" id="submitButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                            提交紀錄
                        </button>
                        <p class="text-xs text-gray-500 text-center mt-2">資料將儲存於雲端資料庫 (Firestore)。</p>
                    </form>
                </div>
                
                <!-- AI 教練分析區 -->
                <div class="mt-6 border-t pt-6">
                    <h2 class="text-xl font-bold text-purple-600 mb-3 flex items-center">
                        <span class="mr-2">🤖</span> AI 教練心得分析
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">根據您輸入的座號，AI 教練將分析您的累積里程並提供激勵性回饋！</p>
                    
                    <button type="button" id="generateReflectionButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200">
                        ✨ 取得 AI 跑步心得
                    </button>

                    <div id="aiReflectionContent" class="mt-4 p-4 bg-purple-50 rounded-lg min-h-[50px] flex items-center justify-center">
                        <p class="text-gray-500 text-sm">點擊上方按鈕開始分析...</p>
                    </div>
                </div>

                <!-- 重置數據按鈕 -->
                <div class="mt-6 border-t pt-6">
                    <button type="button" id="resetDataButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                        🗑️ 重置所有數據 (需管理者密碼)
                    </button>
                    <p class="text-xs text-red-500 text-center mt-2">此為**永久操作**，將清除所有紀錄！</p>
                </div>
            </div>

            <!-- 2. 視覺化地圖區 -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">環島進度視覺化 (矩形跑道)</h2>
                <p class="text-sm text-gray-500 mb-4">點擊地圖上的**學生標記**或**排行榜名單**查看詳細跑步歷程。</p>
                
                <div class="flex flex-col gap-6 justify-center items-center">
                    
                    <!-- 台灣本島色塊地圖網格 -->
                    <div id="taiwan-map-grid" class="w-full max-w-2xl aspect-[5/5]">
                        <!-- 中央競賽主題插圖 (3x3 區塊) -->
                        <div id="central-illustration" class="grid-center-area flex flex-col items-center justify-center p-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 fill-yellow-200">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                                <path d="M4 22h16"></path>
                                <path d="M10 14h4"></path>
                                <path d="M12 17v5"></path>
                                <path d="M12 12A6 6 0 0 0 5 8c0-1.5 1-4 2-5h10c1 1 2 3.5 2 5a6 6 0 0 0-7 4"></path>
                            </svg>
                            <p class="text-2xl font-black text-indigo-700 mt-2 text-center leading-tight">環島挑戰賽<br/>GO GO GO!</p>
                        </div>
                        <!-- 縣市方塊將由 JavaScript 注入此處 -->
                    </div>

                    <!-- 排行榜/總覽 -->
                    <div class="w-full p-4 bg-gray-50 rounded-xl shadow-md flex flex-col justify-start">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">總里程排行榜</h3>
                        <ul id="leaderboard" class="space-y-2">
                            <li class="p-3 text-gray-500 text-center">正在載入數據...</li>
                        </ul>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>

    <!-- 自訂訊息框 -->
    <div id="messageBox" class="fixed bottom-5 right-5 p-4 border rounded-lg shadow-xl z-50 transition-transform duration-300 transform translate-x-full" role="alert">
        <div class="flex items-center">
            <span id="messageIcon" class="text-xl mr-2"></span>
            <span id="messageContent" class="font-medium"></span>
            <button onclick="document.getElementById('messageBox').classList.add('translate-x-full')" class="ml-4 text-gray-500 hover:text-gray-700">&times;</button>
        </div>
    </div>
    
    <!-- 自訂確認對話框 -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-lg mx-4 shadow-2xl transform transition-all scale-100">
            <h3 id="confirmTitle" class="text-2xl font-bold text-red-600 mb-4 border-b pb-2"></h3>
            <p id="confirmMessage" class="text-gray-700 mb-4 leading-relaxed"></p>
            
            <!-- 密碼輸入欄位 -->
            <div class="mb-6">
                <label for="adminPinInput" class="block text-sm font-medium text-gray-700 mb-2">管理者密碼</label>
                <input type="password" id="adminPinInput" class="block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-red-500 focus:ring-red-500" placeholder="請輸入密碼">
            </div>

            <div class="flex justify-end space-x-4">
                <button id="cancelDeleteButton" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="confirmDeleteButton" class="px-6 py-2 border border-transparent rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors shadow-lg">
                    確認刪除
                </button>
            </div>
        </div>
    </div>

    <!-- 跑步歷程紀錄彈窗 -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <!-- Modal Header -->
            <div class="p-6 border-b border-indigo-100 flex justify-between items-center bg-indigo-50">
                <h3 id="historyTitle" class="text-2xl font-bold text-indigo-700">學生跑步歷程</h3>
                <button id="closeHistoryModalButton" class="text-gray-500 hover:text-gray-800 transition-colors text-3xl leading-none">
                    &times;
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto flex-grow">
                <p class="text-lg font-semibold text-gray-600 mb-4">
                    <span id="historyTotal" class="text-green-700">總里程: 0.00 KM</span>
                </p>
                <ul id="historyRecordsList" class="space-y-2">
                    <!-- 歷史紀錄將由 JavaScript 填充 -->
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
