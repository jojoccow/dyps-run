<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç’°å³¶è·‘æ­¥ç´€éŒ„å„€ (å®Œæ•´åŠŸèƒ½ç‰ˆ Firebase V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // ==== Global Variables: Get Config from Canvas Environment (MANDATORY) ====
        const __ENV_FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(__ENV_FIREBASE_CONFIG); 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-running-app'; 
        const apiKey = "" // API Key for Gemini API calls

        // Initialize Firebase Services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const googleProvider = new GoogleAuthProvider();

        // Constants 
        const LAPS_TO_METERS = 200; 
        const ISLAND_LAP_DISTANCE_M = 50000; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let currentUserId = null;
        let currentUserName = 'è¨ªå®¢'; 
        let authReady = false; 
        let listenerActive = false; 
        let allStudentRecords = []; // å„²å­˜æ‰€æœ‰ç´€éŒ„ï¼Œç”¨æ–¼æ­·å²ç´€éŒ„å½ˆçª—
        let studentTotalsMap = {}; // å„²å­˜ç´¯ç©ç¸½æ•¸çš„ Map

        // å°ç£æœ¬å³¶ç¸£å¸‚è³‡æ–™ (çŸ©å½¢è·‘é“ç¯€é»)
        const CITIES_DATA = [
            { id: 'tainan', name: 'å°å—å¸‚', grid: 'col-start-5 row-start-5', color: 'bg-green-600', direction: 'left' }, 
            { id: 'kaohsiung', name: 'é«˜é›„å¸‚', grid: 'col-start-4 row-start-5', color: 'bg-zinc-600', direction: 'left' },
            { id: 'pingtung', name: 'å±æ±ç¸£', grid: 'col-start-3 row-start-5', color: 'bg-teal-600', direction: 'left' },
            { id: 'taitung', name: 'å°æ±ç¸£', grid: 'col-start-2 row-start-5', color: 'bg-cyan-600', direction: 'left' },
            { id: 'hualien', name: 'èŠ±è“®ç¸£', grid: 'col-start-1 row-start-5', color: 'bg-sky-400', direction: 'up' }, 
            { id: 'yilan', name: 'å®œè˜­ç¸£', grid: 'col-start-1 row-start-4', color: 'bg-lime-500', direction: 'up' },
            { id: 'keelung', name: 'åŸºéš†å¸‚', grid: 'col-start-1 row-start-3', color: 'bg-emerald-500', direction: 'up' },
            { id: 'newtaipei', name: 'æ–°åŒ—å¸‚', grid: 'col-start-1 row-start-2', color: 'bg-pink-500', direction: 'up' },
            { id: 'taipei', name: 'å°åŒ—å¸‚', grid: 'col-start-1 row-start-1', color: 'bg-red-500', direction: 'right' }, 
            { id: 'taoyuan', name: 'æ¡ƒåœ’å¸‚', grid: 'col-start-2 row-start-1', color: 'bg-yellow-400', direction: 'right' },
            { id: 'hsinchucty', name: 'æ–°ç«¹ç¸£', grid: 'col-start-3 row-start-1', color: 'bg-teal-500', direction: 'right' },
            { id: 'miaoli', name: 'è‹—æ —ç¸£', grid: 'col-start-4 row-start-1', color: 'bg-purple-500', direction: 'right' },
            { id: 'taichung', name: 'å°ä¸­å¸‚', grid: 'col-start-5 row-start-1', color: 'bg-orange-500', direction: 'down' }, 
            { id: 'changhua', name: 'å½°åŒ–ç¸£', grid: 'col-start-5 row-start-2', color: 'bg-rose-500', direction: 'down' },
            { id: 'yunlin', name: 'é›²æ—ç¸£', grid: 'col-start-5 row-start-3', color: 'bg-fuchsia-600', direction: 'down' }, 
            { id: 'chiayicty', name: 'å˜‰ç¾©ç¸£', grid: 'col-start-5 row-start-4', color: 'bg-pink-400', direction: 'down' }, 
        ];
        
        // ç’°å³¶é€²åº¦é»
        const TAIWAN_PATH_POINTS = [
            { id: 'tainan', name: 'å°å—å¸‚', progress: 0.0000 },
            { id: 'kaohsiung', name: 'é«˜é›„å¸‚', progress: 0.0625 },
            { id: 'pingtung', name: 'å±æ±ç¸£', progress: 0.1250 },
            { id: 'taitung', name: 'å°æ±ç¸£', progress: 0.1875 },
            { id: 'hualien', name: 'èŠ±è“®ç¸£', progress: 0.2500 },
            { id: 'yilan', name: 'å®œè˜­ç¸£', progress: 0.3125 },
            { id: 'keelung', name: 'åŸºéš†å¸‚', progress: 0.3750 },
            { id: 'newtaipei', name: 'æ–°åŒ—å¸‚', progress: 0.4375 },
            { id: 'taipei', name: 'å°åŒ—å¸‚', progress: 0.5000 },
            { id: 'taoyuan', name: 'æ¡ƒåœ’å¸‚', progress: 0.5625 },
            { id: 'hsinchucty', name: 'æ–°ç«¹ç¸£', progress: 0.6250 },
            { id: 'miaoli', name: 'è‹—æ —ç¸£', progress: 0.6875 },
            { id: 'taichung', name: 'å°ä¸­å¸‚', progress: 0.7500 },
            { id: 'changhua', name: 'å½°åŒ–ç¸£', progress: 0.8125 },
            { id: 'yunlin', name: 'é›²æ—ç¸£', progress: 0.8750 },
            { id: 'chiayicty', name: 'å˜‰ç¾©ç¸£', progress: 0.9375 },
            { id: 'tainan_end', name: 'å›åˆ°å°å—', progress: 1.0000 },
        ];
        
        // ==== Utility Functions ====
        
        /** * åŸ·è¡Œå¸¶æœ‰æŒ‡æ•¸é€€é¿çš„ Fetch è«‹æ±‚ 
         * @returns {Promise<Response>}
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        if (i === maxRetries - 1) throw new Error(`Fetch failed after ${maxRetries} retries: ${response.statusText}`);
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Exceeded max retries.");
        }
        
        function getColorHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                const lightValue = Math.min(255, Math.max(100, value + 80)); 
                color += ('00' + lightValue.toString(16)).substr(-2);
            }
            return color;
        }

        function getTextColor(hexcolor) {
            const r = parseInt(hexcolor.substring(1, 3), 16);
            const g = parseInt(hexcolor.substring(3, 5), 16);
            const b = parseInt(hexcolor.substring(5, 7), 16);
            const brightness = (r * 0.2126 + g * 0.7152 + b * 0.0722);
            return (brightness > 140) ? 'black' : 'white';
        }
        
        function populateStudentIdDropdown() {
            const select = document.getElementById('studentId');
            if (!select) return;

            select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡åº§è™Ÿ</option>';

            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                const studentIdValue = i.toString().padStart(2, '0'); 
                option.value = studentIdValue;
                option.textContent = `${i} è™Ÿ (${studentIdValue})`;
                select.appendChild(option);
            }
        }


        // ==== Firebase & Auth Functions ====
        
        const getCollectionRef = () => {
            return collection(db, `artifacts/${appId}/public/data/running_records`);
        };

        function updateAuthStatusUI() {
            const statusElement = document.getElementById('authStatus');
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const recordFormDiv = document.getElementById('recordFormDiv'); 
            const nameInput = document.getElementById('name');
            const aiCoachDiv = document.getElementById('aiCoachDiv');
            const resetDataButton = document.getElementById('resetDataButton');
            
            if (authReady && currentUserId) {
                // å·²ç™»å…¥ï¼šè‡ªå‹•å¡«å…¥å§“åï¼Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
                statusElement.textContent = `âœ… å·²ç™»å…¥ç‚ºï¼š${currentUserName} (ID: ${currentUserId.substring(0, 8)}...)`;
                statusElement.className = 'text-sm font-semibold text-green-700 p-2 rounded-lg bg-green-100 mb-4';
                
                signInButton.classList.add('hidden');
                signOutButton.classList.remove('hidden');
                recordFormDiv.classList.remove('hidden'); 
                aiCoachDiv.classList.remove('hidden'); 
                resetDataButton.classList.remove('hidden'); 
                document.getElementById('currentUserNameSpan').textContent = currentUserName;
                
                nameInput.value = currentUserName; 
                
            } else if (authReady && !currentUserId) {
                // æœªç™»å…¥ï¼šæ¸…é™¤å§“åæ¬„ä½ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                statusElement.textContent = 'ğŸ”’ è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥æäº¤æ‚¨çš„è·‘æ­¥ç´€éŒ„ã€‚';
                statusElement.className = 'text-sm font-semibold text-blue-700 p-2 rounded-lg bg-blue-100 mb-4';
                
                signInButton.classList.remove('hidden');
                signOutButton.classList.add('hidden');
                recordFormDiv.classList.add('hidden'); 
                aiCoachDiv.classList.add('hidden'); 
                resetDataButton.classList.add('hidden');
                document.getElementById('currentUserNameSpan').textContent = 'è¨ªå®¢';
                nameInput.value = ''; 
            } else {
                // æ­£åœ¨é€£ç·š
                statusElement.textContent = 'âŒ› æ­£åœ¨é€£ç·šåˆ°è³‡æ–™åº«...';
                statusElement.className = 'text-sm font-semibold text-yellow-700 p-2 rounded-lg bg-yellow-100 mb-4';
                
                signInButton.classList.add('hidden');
                signOutButton.classList.add('hidden');
                recordFormDiv.classList.add('hidden'); 
                aiCoachDiv.classList.add('hidden'); 
                resetDataButton.classList.add('hidden');
            }
        }
        
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                showMessageBox(`æ­¡è¿ï¼Œ${result.user.displayName || result.user.email}ï¼æ‚¨å·²æˆåŠŸç™»å…¥ã€‚`, "success");
            } catch (error) {
                console.error("Google Sign-in Failed:", error);
                showMessageBox(`âŒ Google ç™»å…¥å¤±æ•—: ${error.message}. è«‹ç¨å¾Œå†è©¦ã€‚`, "error");
            }
        }
        
        async function handleSignOut() {
             try {
                await signOut(auth);
                showMessageBox("æ‚¨å·²æˆåŠŸç™»å‡ºã€‚", "info");
            } catch (error) {
                console.error("Sign-out Failed:", error);
                showMessageBox(`âŒ ç™»å‡ºå¤±æ•—: ${error.message}`, "error");
            }
        }

        function initAuthAndListener() {
            onAuthStateChanged(auth, (user) => {
                authReady = true; 
                const nameInput = document.getElementById('name');
                
                if (user) {
                    currentUserId = user.uid;
                    currentUserName = user.displayName || user.email; 
                    nameInput.value = currentUserName; 
                    
                    if (!listenerActive) {
                        setupRealtimeListener();
                        listenerActive = true;
                    }
                } else {
                    currentUserId = null;
                    currentUserName = 'è¨ªå®¢';
                    nameInput.value = ''; 
                    listenerActive = false; 

                    // æœªç™»å…¥æ™‚æ¸…é™¤æ’è¡Œæ¦œå’Œåœ°åœ–
                    const leaderboard = document.getElementById('leaderboard');
                    if (leaderboard) {
                        leaderboard.innerHTML = '<li class="p-3 text-gray-500 text-center">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹æ’è¡Œæ¦œã€‚</li>';
                        updateMap([]);
                    }
                }
                updateAuthStatusUI(); 
            });
        }
        
        // ==== DOMContentLoaded / Init ====
        document.addEventListener('DOMContentLoaded', () => {
            
            populateStudentIdDropdown(); 
            
            const form = document.getElementById('recordForm');
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            form.addEventListener('submit', handleFormSubmit);
            
            document.getElementById('signInButton').addEventListener('click', signInWithGoogle);
            document.getElementById('signOutButton').addEventListener('click', handleSignOut);
            
            // Re-adding event listeners for reset and AI
            document.getElementById('resetDataButton').addEventListener('click', handleResetData);
            document.getElementById('requestAdviceButton').addEventListener('click', handleRequestAdvice);
            document.getElementById('closeHistoryModal').addEventListener('click', () => {
                document.getElementById('historyModal').classList.add('hidden');
            });
            
            buildBlockMap();

            initAuthAndListener(); 
        });
        
        /**
         * å‹•æ…‹ç”Ÿæˆç¸£å¸‚è‰²å¡Šåœ°åœ–
         */
        function buildBlockMap() {
            const mapGrid = document.getElementById('taiwan-map-grid');
            mapGrid.innerHTML = `
                <div id="central-illustration" class="grid-center-area flex flex-col items-center justify-center p-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 fill-yellow-200">
                        <path d="M12 12A6 6 0 0 0 5 8c0-1.5 1-4 2-5h10c1 1 2 3.5 2 5a6 6 0 0 0-7 4"></path>
                        <path d="M4 22h16"></path>
                    </svg>
                    <p class="text-2xl font-black text-indigo-700 mt-2 text-center leading-tight">ç’°å³¶æŒ‘æˆ°è³½<br/>GO GO GO!</p>
                </div>
            `; 
            
            CITIES_DATA.forEach(region => {
                const block = document.createElement('div');
                block.id = `block-${region.id}`;
                block.className = `city-block ${region.grid} ${region.color} relative`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = region.name;
                nameSpan.className = 'text-center z-10';

                const markerContainer = document.createElement('div');
                markerContainer.id = `marker-container-${region.id}`;
                markerContainer.className = 'absolute inset-0 pointer-events-none z-20';

                block.appendChild(nameSpan);
                block.appendChild(markerContainer);
                mapGrid.appendChild(block);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentUserId) {
                showMessageBox("è«‹å…ˆä½¿ç”¨ Google å¸³è™Ÿç™»å…¥æ‰èƒ½æäº¤ç´€éŒ„ã€‚", "error");
                return;
            }
            
            const name = currentUserName; 
            const studentId = document.getElementById('studentId').value.trim();
            const date = document.getElementById('date').value;
            const laps = parseInt(document.getElementById('laps').value, 10);

            if (!name || !studentId || !date || isNaN(laps) || laps <= 0) {
                showMessageBox("è«‹ç¢ºä¿æ‚¨å·²ç™»å…¥ã€é¸æ“‡åº§è™Ÿï¼Œä¸”æ‰€æœ‰æ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯«ï¼Œåœˆæ•¸å¤§æ–¼ 0ã€‚", "info");
                return;
            }
            
            const distanceMeters = laps * LAPS_TO_METERS;

            const record = {
                name: name,
                studentId: studentId,
                date: date,
                laps: laps,
                distanceMeters: distanceMeters,
                submittedBy: currentUserId, 
                timestamp: serverTimestamp()
            };

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'å„²å­˜ä¸­...';

            try {
                await addDoc(getCollectionRef(), record);
                showMessageBox("è·‘æ­¥ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼", "success");
                document.getElementById('laps').value = '';
                
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox(`å„²å­˜ç´€éŒ„å¤±æ•— (éŒ¯èª¤: ${error.code || error.message})`, "error");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'æäº¤ç´€éŒ„';
            }
        }
        
        /**
         * è™•ç†æ•¸æ“šé‡ç½® (åƒ…ç®¡ç†å“¡å¯æ“ä½œï¼Œæ­¤ç‚ºå®¢æˆ¶ç«¯æ¨¡æ“¬)
         */
        async function handleResetData() {
            const result = await showCustomConfirmation(
                'é‡ç½®æ‰€æœ‰æ•¸æ“š', 
                'æ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å­¸ç”Ÿçš„è·‘æ­¥ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†è½‰ï¼Œåƒ…ä¾›æ‡‰ç”¨ç¨‹å¼ç®¡ç†å“¡ä½¿ç”¨ã€‚',
                'bg-red-500 hover:bg-red-600',
                'ç¢ºå®šåˆªé™¤'
            );
            
            if (!result) return;

            const resetButton = document.getElementById('resetDataButton');
            resetButton.disabled = true;
            resetButton.textContent = 'åˆªé™¤ä¸­...';
            
            try {
                const q = query(getCollectionRef());
                const snapshot = await getDocs(q);
                let deleteCount = 0;
                
                // Firestore ä¸æ”¯æ´æ‰¹æ¬¡åˆªé™¤æ•´å€‹é›†åˆï¼Œéœ€è¦é€å€‹åˆªé™¤
                for (const docSnapshot of snapshot.docs) {
                    await deleteDoc(doc(db, docSnapshot.ref.path));
                    deleteCount++;
                }

                showMessageBox(`âœ… æˆåŠŸåˆªé™¤ ${deleteCount} ç­†è·‘æ­¥ç´€éŒ„ã€‚`, "success");
            } catch (error) {
                console.error("Error deleting documents: ", error);
                showMessageBox(`âŒ æ•¸æ“šé‡ç½®å¤±æ•—ï¼š${error.message}`, "error");
            } finally {
                resetButton.disabled = false;
                resetButton.textContent = 'é‡ç½®æ‰€æœ‰æ•¸æ“š (ç®¡ç†å“¡)';
            }
        }
        
        /**
         * å‘¼å« Gemini API ç²å– AI æ•™ç·´å»ºè­° (æ ¸å¿ƒåŠŸèƒ½)
         */
        async function handleRequestAdvice() {
            const aiOutput = document.getElementById('aiCoachOutput');
            const button = document.getElementById('requestAdviceButton');

            if (Object.keys(studentTotalsMap).length === 0) {
                 aiOutput.innerHTML = '<p class="text-yellow-600">ç›®å‰æ²’æœ‰ä»»ä½•ç´€éŒ„æ•¸æ“šï¼Œç„¡æ³•æä¾›å»ºè­°ã€‚è«‹å…ˆæäº¤ä¸€äº›ç´€éŒ„ã€‚</p>';
                 return;
            }
            
            button.disabled = true;
            button.textContent = 'æ€è€ƒä¸­... ğŸ§ ';
            aiOutput.innerHTML = '<p class="text-gray-500 italic animate-pulse">AI æ•™ç·´æ­£åœ¨åˆ†ææ•¸æ“šä¸¦ç²å–æœ€æ–°è³‡è¨Šï¼Œè«‹ç¨å€™...</p>';
            
            try {
                // å°‡å­¸ç”Ÿç¸½æ•¸æ•¸æ“šè½‰æ›ç‚ºæ˜“æ–¼ LLM è™•ç†çš„æ ¼å¼
                const dataSummary = Object.values(studentTotalsMap).map(s => {
                    const km = (s.totalDistanceM / 1000).toFixed(2);
                    return `${s.name} (åº§è™Ÿ ${s.studentId}): ç¸½é‡Œç¨‹ ${km} KM, ç’°å³¶ ${s.lapsCompleted} æ¬¡`;
                }).join('\n');
                
                const systemPrompt = "ä½ æ˜¯ä¸€ä½è¦ªåˆ‡ã€å……æ»¿æ´»åŠ›å’Œé¼“å‹µçš„é«”è‚²è€å¸«å…¼ AI è·‘æ­¥æ•™ç·´ã€‚è«‹æ ¹æ“šæä¾›çš„å­¸ç”Ÿè·‘æ­¥ç¸½é‡Œç¨‹æ•¸æ“šï¼Œçµ¦å‡ºä»¥ä¸‹å»ºè­°ï¼š1. å°ç¸½é‡Œç¨‹æœ€é«˜çš„å­¸ç”Ÿçµ¦äºˆå…·é«”é¼“å‹µã€‚2. å°é€²åº¦è½å¾Œæˆ–å°šæœªé–‹å§‹çš„å­¸ç”Ÿçµ¦äºˆæº«å’Œçš„é¼“å‹µå’Œå¯¦ç”¨å»ºè­°ã€‚3. æ ¹æ“šæœ€æ–°çš„é«”è‚²æ–°èæˆ–è·‘æ­¥çŸ¥è­˜ï¼Œæä¾›ä¸€å€‹é—œæ–¼è·‘æ­¥æŠ€è¡“æˆ–é‹å‹•ç‡Ÿé¤Šçš„å¯¦ç”¨æç¤ºã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸¦ä¿æŒç°¡æ½”å’Œç†±æƒ…ã€‚";
                
                const userQuery = `è«‹åˆ†æä»¥ä¸‹å­¸ç”Ÿçš„è·‘æ­¥æ•¸æ“šï¼Œä¸¦æä¾›å»ºè­°ï¼š\n\n---æ•¸æ“š---\n${dataSummary}\n\n---ç›®æ¨™---\nç’°å³¶ä¸€åœˆæ˜¯ 50 å…¬é‡Œã€‚è«‹å°ˆæ³¨æ–¼æ¿€å‹µå’Œå¯¦ç”¨å»ºè­°ã€‚`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                const response = await exponentialBackoffFetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];
                let text = "AI æ•™ç·´æš«æ™‚ç„¡æ³•æä¾›å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    text = candidate.content.parts[0].text;
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }
                }
                
                // æ ¼å¼åŒ–è¼¸å‡º
                let formattedText = text.replace(/\n/g, '<br>');
                aiOutput.innerHTML = `<p class="text-gray-800">${formattedText}</p>`;
                
                if (sources.length > 0) {
                    let sourceHtml = '<p class="text-xs text-gray-500 mt-4 border-t pt-2">è³‡æ–™ä¾†æº (Google Search):<ul class="list-disc ml-4 mt-1">';
                    sources.forEach(s => {
                        sourceHtml += `<li><a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline">${s.title}</a></li>`;
                    });
                    sourceHtml += '</ul></p>';
                    aiOutput.innerHTML += sourceHtml;
                }

            } catch (error) {
                console.error("AI Coach API Error:", error);
                aiOutput.innerHTML = '<p class="text-red-600">âŒ AI æ•™ç·´é€£ç·šå¤±æ•—æˆ–ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API Keyã€‚</p>';
            } finally {
                button.disabled = false;
                button.textContent = 'ç´¢å– AI æ•™ç·´å»ºè­°';
            }
        }

        function getCityInfoByProgress(progress) {
            const currentProgress = progress % 1.0; 
            
            for (let i = 0; i < TAIWAN_PATH_POINTS.length - 1; i++) {
                const p1 = TAIWAN_PATH_POINTS[i];
                const p2 = TAIWAN_PATH_POINTS[i + 1];

                if (currentProgress >= p1.progress && currentProgress < p2.progress) {
                    const segmentLength = p2.progress - p1.progress;
                    const progressInCity = (currentProgress - p1.progress) / segmentLength; 
                    
                    return {
                        cityId: p1.id,
                        cityName: p1.name.replace(/\/.*/, '').replace('å›åˆ°', ''),
                        progressInCity: progressInCity
                    };
                }
            }
            
            if (currentProgress === 0.0 && progress > 0) {
                 const startCity = TAIWAN_PATH_POINTS[0];
                 return {
                    cityId: startCity.id,
                    cityName: startCity.name.replace(/\/.*/, '').replace('å›åˆ°', ''),
                    progressInCity: 1.0 
                };
            }
            
            const startCity = TAIWAN_PATH_POINTS[0];
            return {
                cityId: startCity.id,
                cityName: startCity.name.replace(/\/.*/, '').replace('å›åˆ°', ''),
                progressInCity: 0.0
            };
        }

        // ==== æ•¸æ“šç›£è½èˆ‡è™•ç† ====
        function setupRealtimeListener() {
            if (!currentUserId && listenerActive) {
                return;
            }

            const recordsQuery = query(getCollectionRef()); 
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '<li class="p-3 text-gray-500 text-center animate-pulse">ğŸƒ æ­£åœ¨å¾é›²ç«¯è¼‰å…¥æ•¸æ“š...</li>';

            onSnapshot(recordsQuery, (snapshot) => {
                allStudentRecords = [];
                snapshot.forEach((doc) => {
                    // ç¢ºä¿ document ID è¢«å„²å­˜ï¼Œä»¥ä¾¿åœ¨ history modal ä¸­å¯èƒ½ä½¿ç”¨
                    allStudentRecords.push({...doc.data(), id: doc.id});
                });
                processRecords(allStudentRecords);
            }, (error) => {
                console.error("Error listening to running records:", error);
                showMessageBox("ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«æˆ–æ¬Šé™ä¸è¶³ã€‚ç„¡æ³•é¡¯ç¤ºæ’è¡Œæ¦œã€‚", "error");
            });
            listenerActive = true; 
        }
        
        /**
         * è™•ç†ç´€éŒ„ä¸¦æ›´æ–°æ’è¡Œæ¦œå’Œåœ°åœ–
         */
        function processRecords(records) {
            studentTotalsMap = {};
            const leaderboard = document.getElementById('leaderboard');
            
            leaderboard.innerHTML = ''; 
            
            // ç´¯è¨ˆæ¯å€‹å­¸ç”Ÿçš„ç¸½é‡Œç¨‹
            records.forEach(record => {
                const key = record.studentId;
                if (!studentTotalsMap[key]) {
                    studentTotalsMap[key] = {
                        name: record.name,
                        studentId: key,
                        totalDistanceM: 0,
                        lapsCompleted: 0
                    };
                }
                const distance = typeof record.distanceMeters === 'number' ? record.distanceMeters : 0;
                studentTotalsMap[key].totalDistanceM += distance; 
                studentTotalsMap[key].lapsCompleted = Math.floor(studentTotalsMap[key].totalDistanceM / ISLAND_LAP_DISTANCE_M);
            });
            
            let students = Object.values(studentTotalsMap);
            
            if (students.length === 0) {
                 leaderboard.innerHTML = '<li class="p-3 text-gray-500 text-center">ç›®å‰æ²’æœ‰ä»»ä½•è·‘æ­¥ç´€éŒ„ã€‚è«‹æäº¤æ‚¨çš„ç¬¬ä¸€ç­†ç´€éŒ„ï¼</li>';
                 updateMap([]); 
                 return;
            }
            
            // åœ¨å®¢æˆ¶ç«¯é€²è¡Œæ’åº
            students.sort((a, b) => b.totalDistanceM - a.totalDistanceM);

            // æ¸²æŸ“æ’è¡Œæ¦œä¸¦æ·»åŠ é»æ“Šäº‹ä»¶
            students.forEach((student, index) => {
                const totalKm = (student.totalDistanceM / 1000).toFixed(2);
                const li = document.createElement('li');
                li.className = 'p-3 bg-white/70 backdrop-blur-sm rounded-xl flex justify-between items-center shadow-md mb-2 transition-all duration-300 hover:shadow-lg cursor-pointer'; 
                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg w-6 text-center text-indigo-600">${index + 1}</span>
                        <span class="text-gray-800 font-medium truncate">${student.name} (${student.studentId})</span>
                    </div>
                    <span class="font-mono text-xl text-green-700">${totalKm} KM</span>
                `;
                li.addEventListener('click', () => showHistoryModal(student.studentId, student.name));
                leaderboard.appendChild(li);
            });
            
            updateMap(students);
        }

        // ==== åœ°åœ–æ¨™è¨˜èˆ‡é€²åº¦æ¢æ›´æ–° ====
        function updateMap(students) {
            // ... (åœ°åœ–æ›´æ–°é‚è¼¯èˆ‡ v1 ç›¸åŒï¼Œçœç•¥é‡è¤‡ç¨‹å¼ç¢¼) ...
            
            // 1. æ¸…é™¤èˆŠçš„æ¨™è¨˜å’Œé€²åº¦æ¢
            CITIES_DATA.forEach(city => {
                const container = document.getElementById(`marker-container-${city.id}`);
                if (container) {
                    container.innerHTML = '';
                }
                const cityBlock = document.getElementById(`block-${city.id}`);
                const existingBars = cityBlock ? cityBlock.querySelectorAll('.progress-bar-student') : [];
                existingBars.forEach(bar => bar.remove());
            });

            const barThickness = '4px';

            students.forEach(student => {
                const totalDistance = student.totalDistanceM;
                const fullLaps = Math.floor(totalDistance / ISLAND_LAP_DISTANCE_M);
                const currentLapProgress = (totalDistance % ISLAND_LAP_DISTANCE_M) / ISLAND_LAP_DISTANCE_M;
                
                const { cityId, progressInCity } = getCityInfoByProgress(currentLapProgress);
                const cityData = CITIES_DATA.find(c => c.id === cityId);
                
                if (!cityData) return;
                const direction = cityData.direction;

                const cityBlock = document.getElementById(`block-${cityId}`);
                const container = document.getElementById(`marker-container-${cityId}`);
                
                if (!cityBlock || !container) return; 

                // 2. é€²åº¦æ¢ (Progress Bar)
                let progressBar = document.getElementById(`progress-bar-${student.studentId}`);
                
                if (progressBar && progressBar.parentElement !== cityBlock) {
                    progressBar.parentElement.removeChild(progressBar);
                    progressBar = null; 
                }
                
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.id = `progress-bar-${student.studentId}`;
                    progressBar.className = 'absolute transition-all duration-1000 ease-out z-0 opacity-80 progress-bar-student rounded-sm';
                    cityBlock.appendChild(progressBar);
                }
                
                progressBar.style.top = '';
                progressBar.style.bottom = '';
                progressBar.style.left = '';
                progressBar.style.right = '';
                progressBar.style.width = '';
                progressBar.style.height = ''; 
                progressBar.style.transform = ''; 

                const progressPercent = `${progressInCity * 100}%`;
                const uniqueColor = getColorHash(student.studentId);
                
                progressBar.style.backgroundColor = uniqueColor; 
                
                switch (direction) {
                    case 'right': 
                    case 'left': 
                        progressBar.style.top = '50%';
                        progressBar.style.height = barThickness;
                        progressBar.style.width = progressPercent;
                        progressBar.style.transform = 'translateY(-50%)'; 
                        if (direction === 'right') {
                            progressBar.style.left = '0';
                        } else { // 'left'
                            progressBar.style.right = '0'; 
                        }
                        break;
                    case 'up': 
                    case 'down': 
                        progressBar.style.left = '50%';
                        progressBar.style.width = barThickness;
                        progressBar.style.height = progressPercent;
                        progressBar.style.transform = 'translateX(-50%)'; 
                        if (direction === 'up') {
                            progressBar.style.bottom = '0';
                        } else { // 'down'
                            progressBar.style.top = '0'; 
                        }
                        break;
                }
                
                // 3. æ¨™è¨˜ (Marker) 
                let marker = document.getElementById(`marker-${student.studentId}`);
                if (!marker) {
                    marker = document.createElement('div');
                    marker.id = `marker-${student.studentId}`;
                    marker.className = `student-marker absolute px-2 h-6 rounded-full shadow-lg border-2 flex items-center justify-center font-bold text-xs whitespace-nowrap transition-all duration-1000 ease-out z-30 cursor-pointer`; 
                    container.appendChild(marker); 
                    marker.addEventListener('click', () => showHistoryModal(student.studentId, student.name));
                }
                
                marker.style.backgroundColor = uniqueColor; 
                marker.style.borderColor = '#1f2937'; 
                marker.style.color = getTextColor(uniqueColor); 
                
                const markerPosition = `${progressInCity * 100}%`; 
                
                marker.style.top = '';
                marker.style.left = '';
                marker.style.right = '';
                marker.style.bottom = '';
                marker.style.transform = ''; 

                marker.title = `${student.name} (${student.studentId})ï¼šç¸½é‡Œç¨‹ ${(totalDistance / 1000).toFixed(2)} KM (å·²å®Œæˆ ${fullLaps} æ¬¡ç’°å³¶)ã€‚é»æ“ŠæŸ¥çœ‹æ­·å²ç´€éŒ„ã€‚`;
                marker.textContent = student.studentId; // Marker é¡¯ç¤ºåº§è™Ÿä»¥ç¯€çœç©ºé–“
                
                switch (direction) {
                    case 'right': 
                        marker.style.top = '50%';
                        marker.style.left = markerPosition; 
                        marker.style.transform = 'translate(-50%, -50%)'; 
                        break;
                    case 'left': 
                        marker.style.top = '50%'; 
                        marker.style.right = markerPosition;
                        marker.style.transform = 'translate(50%, -50%)'; 
                        break;
                    case 'up': 
                        marker.style.left = '50%'; 
                        marker.style.bottom = markerPosition; 
                        marker.style.transform = 'translate(-50%, 50%)'; 
                        break;
                    case 'down': 
                        marker.style.left = '50%'; 
                        marker.style.top = markerPosition; 
                        marker.style.transform = 'translate(-50%, -50%)'; 
                        break;
                }
                
                if (marker.parentElement !== container) {
                    container.appendChild(marker);
                }
            });
        }
        
        // ==== æ­·å²ç´€éŒ„å½ˆçª— (Modal) åŠŸèƒ½ ====
        function showHistoryModal(studentId, studentName) {
            const modal = document.getElementById('historyModal');
            const recordsList = document.getElementById('studentRecordsList');
            const totalSummary = document.getElementById('totalSummary');
            
            document.getElementById('historyModalTitle').textContent = `${studentName} (${studentId}) çš„è©³ç´°è·‘æ­¥æ­·å²ç´€éŒ„`;
            recordsList.innerHTML = '';
            
            const studentRecords = allStudentRecords
                .filter(r => r.studentId === studentId)
                // ä¾æ—¥æœŸæ™‚é–“å€’åºæ’åˆ—
                .sort((a, b) => {
                    const timeA = a.timestamp?.seconds || new Date(a.date).getTime() / 1000;
                    const timeB = b.timestamp?.seconds || new Date(b.date).getTime() / 1000;
                    return timeB - timeA;
                });

            let cumulativeDistance = 0;
            
            if (studentRecords.length === 0) {
                recordsList.innerHTML = '<p class="text-center text-gray-500 p-4">æŸ¥ç„¡æ­¤å­¸ç”Ÿçš„æ­·å²ç´€éŒ„ã€‚</p>';
                totalSummary.textContent = `ç¸½ç´¯ç©é‡Œç¨‹: 0.00 KM / å·²ç’°å³¶: 0 æ¬¡`;
                modal.classList.remove('hidden');
                return;
            }

            studentRecords.forEach(record => {
                const distanceKm = (record.distanceMeters / 1000).toFixed(2);
                cumulativeDistance += record.distanceMeters;
                
                const dateDisplay = record.date || 'æœªçŸ¥æ—¥æœŸ';
                const timeDisplay = record.timestamp ? new Date(record.timestamp.seconds * 1000).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : '';
                
                const li = document.createElement('li');
                li.className = 'p-3 border-b border-gray-100 flex justify-between items-center hover:bg-indigo-50 transition-colors duration-150 rounded-lg';
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-700">${dateDisplay} <span class="text-xs text-gray-400">${timeDisplay}</span></span>
                        <span class="text-sm text-gray-500">${record.laps} åœˆ (200m/åœˆ)</span>
                    </div>
                    <span class="font-bold text-lg text-indigo-600">${distanceKm} KM</span>
                `;
                recordsList.appendChild(li);
            });
            
            const totalKm = (cumulativeDistance / 1000).toFixed(2);
            const lapsCompleted = Math.floor(cumulativeDistance / ISLAND_LAP_DISTANCE_M);
            totalSummary.textContent = `ç¸½ç´¯ç©é‡Œç¨‹: ${totalKm} KM / å·²ç’°å³¶: ${lapsCompleted} æ¬¡`;

            modal.classList.remove('hidden');
        }
        
        // ==== è‡ªè¨‚ç¢ºèªæ¡† (å–ä»£ alert/confirm) ====
        function showCustomConfirmation(title, message, buttonClass, buttonText) {
            return new Promise(resolve => {
                const modal = document.getElementById('customConfirmationModal');
                const titleEl = document.getElementById('confirmationTitle');
                const messageEl = document.getElementById('confirmationMessage');
                const confirmBtn = document.getElementById('confirmActionButton');
                const cancelBtn = document.getElementById('cancelActionButton');

                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.className = `w-full px-4 py-2 text-white font-medium rounded-lg shadow-sm transition-colors duration-150 ${buttonClass}`;
                confirmBtn.textContent = buttonText;

                const close = (result) => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    resolve(result);
                };

                const onConfirm = () => close(true);
                const onCancel = () => close(false);

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);

                modal.classList.remove('hidden');
            });
        }

        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('messageBox');
            const content = document.getElementById('messageContent');
            const icon = document.getElementById('messageIcon');
            const boxClasses = {
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700',
                info: 'bg-blue-100 border-blue-400 text-blue-700'
            };
            const iconContent = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            const baseClasses = 'fixed bottom-5 right-5 p-4 border rounded-lg shadow-xl z-50 transition-transform duration-300 transform';
            
            box.className = `${baseClasses} translate-x-full ${boxClasses[type]}`;
            
            icon.textContent = iconContent[type];
            content.textContent = message;

            void box.offsetWidth; 

            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                box.classList.remove('translate-x-0');
                box.classList.add('translate-x-full');
            }, 8000); 
        }
        
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* è‰²å¡Šåœ°åœ–ç¶²æ ¼å®¹å™¨ */
        #taiwan-map-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr)); 
            grid-template-rows: repeat(5, minmax(80px, 1fr));
            gap: 4px;
            background-color: #ecf0f1; 
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            height: auto;
            overflow: hidden;
        }
        
        /* å®šç¾©æ¯å€‹ç¸£å¸‚æ–¹å¡Šçš„å…±åŒæ¨£å¼ */
        .city-block {
            @apply p-2 text-white font-bold text-base flex items-center justify-center shadow-inner transition-all duration-300 ease-in-out cursor-default;
            border: 2px solid rgba(255, 255, 255, 0.6);
            min-height: 80px; 
            overflow: hidden;
        }

        .city-block > span {
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
        }
        
        /* ä¸­å¤®ç«¶è³½ä¸»é¡Œå€å¡Š CSS */
        .grid-center-area {
            grid-column: 2 / 5;
            grid-row: 2 / 5;   
            background-color: #ffffff;
            border: 4px dashed #6366f1;
            border-radius: 1rem;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            z-index: 5;
            animation: pulse-border 3s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
            50% { border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); }
            100% { border-color: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
        }
        
        .student-marker {
            border-style: solid; 
            border-width: 2px;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">ğŸƒâ€â™‚ï¸ å­¸ç”Ÿç’°å³¶è·‘æ­¥é‡Œç¨‹å„€ (å®Œæ•´åŠŸèƒ½ç‰ˆ Firebase V2) ğŸ‡¹ğŸ‡¼</h1>
            <p class="text-xl text-gray-600">è·‘æ­¥é€²åº¦è¦–è¦ºåŒ–ï¼šæ²¿è‘—çŸ©å½¢ç’°ç‹€è·‘é“é †æ™‚é‡ç¹è¡Œï¼</p>
            <p class="text-sm text-gray-500 mt-1">è™›æ“¬ç’°å³¶è·‘é“ä¸€åœˆç‚º <span class="font-bold text-red-500">50,000 å…¬å°º (50 å…¬é‡Œ)</span>ã€‚</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 1. è³‡æ–™è¼¸å…¥å€ -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl h-fit sticky top-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">èº«ä»½é©—è­‰èˆ‡ç´€éŒ„è¼¸å…¥</h2>
                
                <div id="authStatus" class="text-sm font-semibold text-yellow-700 p-2 rounded-lg bg-yellow-100 mb-4">
                    âŒ› æ­£åœ¨é€£ç·šåˆ°è³‡æ–™åº«...
                </div>
                
                <!-- ç™»å…¥/ç™»å‡ºæŒ‰éˆ• -->
                <button type="button" id="signInButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 hidden mb-3">
                    <svg class="inline-block w-5 h-5 mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <path fill="#FFC107" d="M43.6 20.4H24v7.5h11.3c-.7 4.2-4 8-9.3 8-6 0-10.9-4.9-10.9-10.9S14.7 14.1 20.7 14.1c3.2 0 5.8 1.4 7.7 3.2l5.7-5.7C30.6 6.8 25.8 4 20.7 4 11.2 4 3.4 11.8 3.4 21.3s7.8 17.3 17.3 17.3c9.9 0 17.1-7.1 17.1-17.1 0-1.1-.1-2.2-.4-3.3z"></path>
                        <path fill="#FF3D00" d="M6.3 18.5l6.3 4.9C14.7 20 17.5 18.5 20.7 18.5c3.2 0 5.8 1.4 7.7 3.2l5.7-5.7c-2-1.9-4.6-3.2-7.7-3.2C13.2 12.8 8.8 15.3 6.3 18.5z"></path>
                        <path fill="#4CAF50" d="M20.7 41.6c-5.1 0-9.5-2.5-12.2-6.4l6.3-4.9c1.9 2.8 4.9 4.6 8.7 4.6 4.7 0 8.6-3.1 10-7.2h6.8c-1.3 5.3-6.2 9.2-13.6 9.2z"></path>
                        <path fill="#1976D2" d="M43.6 20.4H24v7.5h11.3c-.7 4.2-4 8-9.3 8-3.8 0-7.2-1.8-9.4-4.6l-6.3 4.9c4 6.3 10.9 9.8 17.6 9.8 11.2 0 19.8-7.9 19.8-17.6 0-1.1-.1-2.2-.4-3.3z"></path>
                    </svg>
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
                <button type="button" id="signOutButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200 hidden mb-3">
                    ğŸ‘‹ ç™»å‡º (ç›®å‰èº«ä»½: <span id="currentUserNameSpan">è¨ªå®¢</span>)
                </button>
                
                <!-- ç´€éŒ„è¡¨å–® (æœªç™»å…¥æ™‚éš±è—) -->
                <div id="recordFormDiv" class="space-y-4 hidden">
                    <form id="recordForm" class="space-y-4">
                        <p class="text-sm text-gray-600 border-t pt-3">è«‹ç¢ºä¿è³‡æ–™æ­£ç¢ºï¼Œä»¥åˆ©æ•¸æ“šç´¯ç©å’Œè¨ˆç®—ã€‚</p>
                        
                        <!-- å§“å (Readonly - è‡ªå‹•å¡«å…¥ç™»å…¥è€…åç¨±) -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">å§“å (ç”±ç™»å…¥å¸³è™Ÿè‡ªå‹•å¡«å¯« - å”¯è®€)</label>
                            <input type="text" id="name" required readonly class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 bg-gray-100 text-gray-600 focus:outline-none">
                        </div>
                        
                        <!-- åº§è™Ÿ (Dropdown Select: 1-30) -->
                        <div>
                            <label for="studentId" class="block text-sm font-medium text-gray-700">åº§è™Ÿ / ç·¨è™Ÿ (1-30)</label>
                            <select id="studentId" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 bg-white">
                                <!-- Options will be generated by JavaScript: 01, 02... 30 -->
                            </select>
                        </div>

                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                        </div>

                        <div>
                            <label for="laps" class="block text-sm font-medium text-gray-700">è·‘æ­¥åœˆæ•¸ (200 å…¬å°º/åœˆ)</label>
                            <input type="number" id="laps" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥å®Œæˆåœˆæ•¸">
                        </div>

                        <button type="submit" id="submitButton" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                            æäº¤ç´€éŒ„
                        </button>
                        <p class="text-xs text-gray-500 text-center mt-2">è³‡æ–™å°‡å„²å­˜æ–¼é›²ç«¯è³‡æ–™åº« (Firestore)ã€‚</p>
                    </form>
                    
                    <!-- æ•¸æ“šé‡ç½®æŒ‰éˆ• (é‚„åŸåŠŸèƒ½) -->
                    <button type="button" id="resetDataButton" class="w-full mt-4 py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200 hidden">
                        é‡ç½®æ‰€æœ‰æ•¸æ“š (ç®¡ç†å“¡)
                    </button>
                </div>
                
                <!-- AI æ•™ç·´å»ºè­°å€ (é‚„åŸåŠŸèƒ½) -->
                <div id="aiCoachDiv" class="mt-6 p-4 bg-indigo-50 rounded-xl shadow-inner hidden">
                    <h3 class="text-xl font-bold text-indigo-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" x2="12" y1="19" y2="22"></line>
                        </svg>
                        AI è·‘æ­¥æ•™ç·´
                    </h3>
                    <button id="requestAdviceButton" class="w-full py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 transition-colors duration-200 mb-3">
                        ç´¢å– AI æ•™ç·´å»ºè­°
                    </button>
                    <div id="aiCoachOutput" class="text-sm p-3 bg-white rounded-lg border border-purple-200 min-h-[50px] overflow-auto">
                        <p class="text-gray-500">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼ŒAI æ•™ç·´å°‡åˆ†æç›®å‰çš„æ’è¡Œæ¦œæ•¸æ“šï¼Œä¸¦æä¾›é¼“å‹µå’Œå°ˆæ¥­å»ºè­°ï¼</p>
                    </div>
                </div>
            </div>

            <!-- 2. è¦–è¦ºåŒ–åœ°åœ–å€ -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">ç’°å³¶é€²åº¦è¦–è¦ºåŒ– (çŸ©å½¢è·‘é“)</h2>
                <p class="text-sm text-gray-500 mb-4">æ­¤è™•é¡¯ç¤ºæ‰€æœ‰å­¸ç”Ÿçš„ç´¯ç©è·‘æ­¥é€²åº¦ã€‚**é»æ“Šæ’è¡Œæ¦œé …ç›®æˆ–åœ°åœ–æ¨™è¨˜**å¯æŸ¥çœ‹è©³ç´°æ­·å²ã€‚</p>
                
                <div class="flex flex-col gap-6 justify-center items-center">
                    
                    <!-- å°ç£æœ¬å³¶è‰²å¡Šåœ°åœ–ç¶²æ ¼ -->
                    <div id="taiwan-map-grid" class="w-full max-w-2xl aspect-[5/5]">
                        <!-- ç¸£å¸‚æ–¹å¡Šå°‡ç”± JavaScript æ³¨å…¥æ­¤è™• -->
                    </div>

                    <!-- æ’è¡Œæ¦œ/ç¸½è¦½ -->
                    <div class="w-full p-4 bg-gray-50 rounded-xl shadow-md flex flex-col justify-start">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">ç¸½é‡Œç¨‹æ’è¡Œæ¦œ</h3>
                        <ul id="leaderboard" class="space-y-2">
                            <li class="p-3 text-gray-500 text-center">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</li>
                        </ul>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>

    <!-- æ­·å²ç´€éŒ„å½ˆçª— Modal (é‚„åŸåŠŸèƒ½) -->
    <div id="historyModal" class="fixed inset-0 z-40 hidden modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-6 transform transition-all duration-300 scale-100">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="historyModalTitle" class="text-2xl font-bold text-indigo-600">è©³ç´°è·‘æ­¥æ­·å²ç´€éŒ„</h3>
                <button id="closeHistoryModal" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <p id="totalSummary" class="text-lg font-semibold text-gray-700 mb-4 p-2 bg-yellow-50 rounded-lg border border-yellow-200">ç¸½ç´¯ç©é‡Œç¨‹: 0.00 KM / å·²ç’°å³¶: 0 æ¬¡</p>

            <div class="max-h-96 overflow-y-auto">
                <ul id="studentRecordsList" class="divide-y divide-gray-200">
                    <!-- ç´€éŒ„åˆ—è¡¨å°‡ç”± JavaScript å¡«å…… -->
                </ul>
            </div>
            
            <div class="mt-4 pt-4 border-t">
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="w-full py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
    
    <!-- è‡ªè¨‚ç¢ºèªæ¡† (ç”¨æ–¼é‡ç½®æ•¸æ“š) -->
    <div id="customConfirmationModal" class="fixed inset-0 z-40 hidden modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6">
            <h3 id="confirmationTitle" class="text-xl font-bold text-gray-800 mb-3">ç¢ºèªæ“ä½œ</h3>
            <p id="confirmationMessage" class="text-gray-600 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex space-x-4">
                <button id="cancelActionButton" class="w-full px-4 py-2 text-gray-700 font-medium bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-150">
                    å–æ¶ˆ
                </button>
                <button id="confirmActionButton" class="w-full px-4 py-2 text-white font-medium rounded-lg shadow-sm transition-colors duration-150">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªè¨‚è¨Šæ¯æ¡† (Toast Message Box) -->
    <div id="messageBox" class="fixed bottom-5 right-5 p-4 border rounded-lg shadow-xl z-50 transition-transform duration-300 transform translate-x-full" role="alert">
        <div class="flex items-center">
            <span id="messageIcon" class="text-xl mr-2"></span>
            <span id="messageContent" class="font-medium"></span>
            <button onclick="document.getElementById('messageBox').classList.add('translate-x-full')" class="ml-4 text-gray-500 hover:text-gray-700">&times;</button>
        </div>
    </div>
</body>
</html>
